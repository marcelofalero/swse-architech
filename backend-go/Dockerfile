FROM golang:1.24-alpine

# Install build dependencies, Node.js, and CA certificates
# shadow: for user/group management (useradd/groupadd)
# su-exec: for stepping down from root in entrypoint
RUN apk add --no-cache \
    git \
    ca-certificates \
    curl \
    nodejs \
    npm \
    bash \
    shadow \
    su-exec

# Install Wrangler globally
RUN npm install -g wrangler

# Create a non-root user (appuser) with UID/GID 1000
RUN groupadd -g 1000 appuser && \
    useradd -u 1000 -g appuser -m -s /bin/bash appuser

# Set up the app directory and permissions
WORKDIR /app
# We keep root as the default user so entrypoint can fix permissions
# But we ensure the directories are owned by appuser initially
RUN chown -R appuser:appuser /app

# Ensure entrypoint is executable
COPY backend-go/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Create the backend-go directory to ensure permissions are correct when mounting
RUN mkdir -p /app/backend-go && chown -R appuser:appuser /app/backend-go

# Copy source and build the application inside the image
# We temporarily switch to appuser to build, ensuring artifacts are owned by appuser
USER appuser
WORKDIR /app/backend-go
COPY --chown=appuser:appuser backend-go/ .
RUN GOOS=js GOARCH=wasm go build -buildvcs=false -o /tmp/app.wasm .

# Switch back to root for entrypoint execution (to fix volume permissions)
USER root
# Move built binary to a system path
RUN mv /tmp/app.wasm /usr/local/bin/app.wasm

EXPOSE 8787

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
