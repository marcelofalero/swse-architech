<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWSE Starship Architect</title>
    
    <!-- Quasar & Vue Dependencies -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.prod.css" rel="stylesheet" type="text/css">

    <style>
        /* Print Styles */
        @media print {
            body { background-color: white !important; color: black !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .q-header, .q-footer, .q-drawer { display: none !important; }
            .q-page-container { padding: 0 !important; }
            .q-layout { min-height: auto !important; }
        }
        
        @media screen {
            .print-only { display: none !important; }
        }

        .stat-block {
            font-family: 'Roboto', sans-serif;
            border: 2px solid #333;
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .stat-header {
            background-color: #333;
            color: white;
            padding: 5px 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        .stat-row {
            display: flex;
            border-bottom: 1px solid #ccc;
            padding: 4px 0;
        }
        .stat-label {
            font-weight: bold;
            margin-right: 5px;
        }
        .stat-section {
            margin-top: 10px;
            border-top: 2px solid #333;
            padding-top: 5px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .text-strike {
            text-decoration: line-through;
            color: #888;
        }
    </style>
</head>
<body class="bg-grey-10 text-white">
    <div id="q-app">
        <q-layout view="hHh lpR fFf" class="no-print">
            
            <q-header elevated class="bg-grey-9 text-white">
                <q-toolbar>
                    <q-btn flat round icon="rocket" size="md" class="q-mr-sm"></q-btn>
                    <q-toolbar-title>
                        SWSE Architect
                        <span class="text-subtitle2 q-ml-sm text-grey-4" v-if="shipStore.meta.name">{{ shipStore.meta.name }}</span>
                    </q-toolbar-title>
                    
                    <q-btn flat icon="garage" :label="$t('ui.hangar')" @click="showHangarDialog = true" class="q-mr-sm"></q-btn>
                    <q-btn flat icon="description" :label="$t('ui.sheet')" @click="openSheetPreview"></q-btn>
                    <q-btn flat icon="save" :label="$t('ui.export')" @click="exportYaml"></q-btn>
                    <q-btn flat :label="$i18n.locale === 'en' ? 'ES' : 'EN'" @click="toggleLang" color="amber"></q-btn>
                </q-toolbar>
            </q-header>

            <q-page-container>
                <q-page class="q-pa-md">
                    
                    <!-- DESKTOP LAYOUT -->
                    <div v-if="$q.screen.gt.sm" class="row q-col-gutter-md full-height">
                        <div class="col-3"><stat-panel></stat-panel></div>
                        <div class="col-6">
                             <q-card class="bg-grey-9 full-height column">
                                <q-tabs v-model="centerTab" dense class="text-grey" active-color="primary" indicator-color="primary" align="justify">
                                    <q-tab name="systems" :label="$t('ui.manifest')"></q-tab>
                                </q-tabs>
                                <q-separator></q-separator>
                                <q-tab-panels v-model="centerTab" animated class="bg-grey-9 col">
                                    <q-tab-panel name="systems" class="q-pa-none"><system-list></system-list></q-tab-panel>
                                </q-tab-panels>
                            </q-card>
                        </div>
                        <div class="col-3"><config-panel></config-panel></div>
                    </div>

                    <!-- MOBILE LAYOUT -->
                    <div v-else>
                        <q-tabs v-model="mobileTab" class="bg-grey-9 text-grey-5" active-color="primary" sticky>
                            <q-tab name="overview" icon="analytics" :label="$t('ui.overview')"></q-tab>
                            <q-tab name="systems" icon="build" :label="$t('ui.systems')"></q-tab>
                            <q-tab name="config" icon="tune" :label="$t('ui.config')"></q-tab>
                        </q-tabs>
                        
                        <q-tab-panels v-model="mobileTab" animated class="bg-transparent q-mt-md">
                            <q-tab-panel name="overview" class="q-pa-none"><stat-panel></stat-panel></q-tab-panel>
                            <q-tab-panel name="systems" class="q-pa-none"><system-list></system-list></q-tab-panel>
                            <q-tab-panel name="config" class="q-pa-none"><config-panel></config-panel></q-tab-panel>
                        </q-tab-panels>

                        <!-- Mobile Sticky Footer -->
                        <q-footer class="bg-grey-10 border-top-primary">
                            <div class="row items-center q-pa-sm justify-between">
                                <div class="column">
                                    <div class="text-caption text-grey-4">{{ $t('ui.free_ep') }}</div>
                                    <div :class="shipStore.remainingEP < 0 ? 'text-h6 text-negative' : 'text-h6 text-amber'">
                                        {{ shipStore.remainingEP }}
                                    </div>
                                </div>
                                <div class="text-h6 text-primary">
                                    {{ formatCreds(shipStore.totalCost) }}
                                </div>
                            </div>
                        </q-footer>
                    </div>

                </q-page>
            </q-page-container>
        </q-layout>

        <!-- SHEET PREVIEW DIALOG -->
        <q-dialog v-model="showSheetDialog" maximized transition-show="slide-up" transition-hide="slide-down">
            <q-card class="bg-white text-black">
                <q-bar class="bg-grey-9 text-white print-hide">
                    <q-space></q-space>
                    <q-btn dense flat icon="print" :label="$t('ui.print_btn')" @click="triggerPrint" class="q-mr-md"></q-btn>
                    <q-btn dense flat icon="close" v-close-popup></q-btn>
                </q-bar>
                <q-card-section class="q-pa-lg sheet-container"><ship-sheet></ship-sheet></q-card-section>
            </q-card>
        </q-dialog>

        <!-- ADD MOD DIALOG -->
        <q-dialog v-model="shipStore.showAddModDialog">
            <q-card class="bg-grey-9 text-white" style="min-width: 500px">
                <q-card-section>
                    <div class="text-h6">{{ $t('ui.install_system') }}</div>
                    <div class="text-caption text-grey">{{ $t('ui.install_caption') }}</div>
                </q-card-section>

                <q-card-section class="q-pt-none q-gutter-md">
                    <!-- Form Elements -->
                    <q-select filled dark v-model="newModCategory" :options="categoryOptions" :label="$t('ui.category')" emit-value map-options @update:model-value="resetGroup">
                        <template v-slot:prepend><q-icon name="folder" /></template>
                    </q-select>
                    <q-select filled dark v-model="newModGroup" :options="groupOptions" :label="$t('ui.sys_type')" emit-value map-options :disable="!newModCategory" @update:model-value="newModSelection = null">
                        <template v-slot:prepend><q-icon name="category" /></template>
                    </q-select>
                    <q-select filled dark v-model="newModSelection" :options="itemOptions" :label="$t('ui.component')" option-label="label" option-value="id" emit-value map-options :disable="!newModGroup">
                        <template v-slot:option="scope">
                            <q-item v-bind="scope.itemProps" :disable="!isSizeValid(scope.opt)">
                                <q-item-section>
                                    <q-item-label>
                                        {{ scope.opt.label }}
                                        <q-badge v-if="scope.opt.availability === 'Licensed'" color="info" label="Lic" />
                                        <q-badge v-if="scope.opt.availability === 'Restricted'" color="warning" text-color="black" label="Res" />
                                        <q-badge v-if="scope.opt.availability === 'Military'" color="negative" label="Mil" />
                                    </q-item-label>
                                    <q-item-label caption class="text-grey-5" v-if="!isSizeValid(scope.opt)">
                                        <q-icon name="block" color="negative" class="q-mr-xs"/> {{ $t('ui.max_size') }}: {{ scope.opt.maxSize }}
                                    </q-item-label>
                                </q-item-section>
                            </q-item>
                        </template>
                    </q-select>
                    <div v-if="newModSelection">
                        <q-checkbox dark v-model="newModNonStandard" :label="$t('ui.non_standard')" color="warning">
                            <q-tooltip>{{ $t('ui.non_standard_tip') }}</q-tooltip>
                        </q-checkbox>
                    </div>
                    <q-card v-if="selectedItemDef" class="bg-grey-8 q-pa-sm q-mt-md" flat bordered>
                        <div class="row items-center justify-between">
                            <div>
                                <div class="text-subtitle2">{{ getLocalizedName(selectedItemDef) }} <span v-if="newModNonStandard" class="text-warning text-caption">({{ $t('ui.ns_tag') }})</span></div>
                                <div class="text-caption text-grey-4">
                                    <span v-if="selectedItemDef.variableCost">{{ $t('ui.cost_variable') }}</span>
                                    <span v-else>{{ $t('ui.base_cost') }}: {{ selectedItemDef.baseCost }} cr</span> | {{ $t('ui.base_ep') }}: {{ selectedItemDef.baseEp }}
                                    <br v-if="selectedItemDef.category !== 'Modifications'">
                                    <span v-if="selectedItemDef.category !== 'Modifications'">{{ $t('ui.avail') }}: <span class="text-bold text-amber">{{ $t('avail.' + (selectedItemDef.availability || 'Common')) }}</span></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-h6 text-amber">
                                    <span v-if="selectedItemDef.variableCost" class="text-italic text-body1">{{ $t('ui.variable') }}</span>
                                    <span v-else>{{ formatCreds(previewCost) }}</span>
                                </div>
                                <div class="text-caption text-positive">{{ previewEp }} EP</div>
                            </div>
                        </div>
                        <div v-if="selectedItemDef.sizeMult && !selectedItemDef.variableCost" class="text-xs text-grey-5 q-mt-xs">* {{ $t('ui.size_mult_msg', { size: shipStore.chassis.size }) }}</div>
                    </q-card>
                </q-card-section>
                <q-card-actions align="right">
                    <q-btn flat :label="$t('ui.cancel')" color="grey" v-close-popup></q-btn>
                    <q-btn unelevated :label="$t('ui.install')" color="positive" @click="installMod" v-close-popup :disable="!newModSelection"></q-btn>
                </q-card-actions>
            </q-card>
        </q-dialog>

        <!-- HANGAR DIALOG -->
        <q-dialog v-model="showHangarDialog">
            <q-card class="bg-grey-9 text-white" style="min-width: 500px; max-width: 90vw;">
                <q-card-section><div class="text-h6">{{ $t('ui.hangar') }}</div></q-card-section>
                <q-tabs v-model="hangarTab" dense class="text-grey" active-color="primary" indicator-color="primary" align="justify">
                    <q-tab name="stock" icon="factory" :label="$t('ui.new_stock')"></q-tab>
                    <q-tab name="import" icon="upload_file" :label="$t('ui.import_file')"></q-tab>
                </q-tabs>
                <q-separator dark></q-separator>
                <q-tab-panels v-model="hangarTab" animated class="bg-grey-9">
                    <q-tab-panel name="stock" style="height: 400px" class="q-pa-none">
                        <q-scroll-area class="full-height">
                            <q-list separator dark>
                                <q-item-label header class="text-grey-5">{{ $t('cat.fighters') }}</q-item-label>
                                <q-item clickable v-ripple v-for="ship in stockFighters" :key="ship.id" @click="selectStockShip(ship.id)"><q-item-section><q-item-label>{{ getLocalizedName(ship) }}</q-item-label><q-item-label caption class="text-grey-6">{{ ship.size }}</q-item-label></q-item-section><q-item-section side><q-btn flat round icon="chevron_right" color="primary" /></q-item-section></q-item>
                                <q-item-label header class="text-grey-5">{{ $t('cat.freighters') }}</q-item-label>
                                <q-item clickable v-ripple v-for="ship in stockFreighters" :key="ship.id" @click="selectStockShip(ship.id)"><q-item-section><q-item-label>{{ getLocalizedName(ship) }}</q-item-label><q-item-label caption class="text-grey-6">{{ ship.size }}</q-item-label></q-item-section><q-item-section side><q-btn flat round icon="chevron_right" color="primary" /></q-item-section></q-item>
                                <q-item-label header class="text-grey-5">{{ $t('cat.capitals') }}</q-item-label>
                                <q-item clickable v-ripple v-for="ship in stockCapitals" :key="ship.id" @click="selectStockShip(ship.id)"><q-item-section><q-item-label>{{ getLocalizedName(ship) }}</q-item-label><q-item-label caption class="text-grey-6">{{ ship.size }}</q-item-label></q-item-section><q-item-section side><q-btn flat round icon="chevron_right" color="primary" /></q-item-section></q-item>
                            </q-list>
                        </q-scroll-area>
                    </q-tab-panel>
                    <q-tab-panel name="import" style="height: 400px" class="column flex-center">
                        <q-icon name="upload_file" size="100px" color="grey-7" class="q-mb-md">{{ $t('ui.upload_yaml') }}</q-icon>
                        <div class="text-h6 q-mb-md">{{ $t('ui.upload_yaml') }}</div>
                        <input type="file" ref="fileInput" @change="handleFileUpload" accept=".yaml,.yml,.json" style="display: none" />
                        <q-btn color="primary" :label="$t('ui.select_file')" @click="$refs.fileInput.click()"></q-btn>
                    </q-tab-panel>
                </q-tab-panels>
            </q-card>
        </q-dialog>

    </div>

    <!-- DEPENDENCIES -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-i18n@9.2.2/dist/vue-i18n.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.umd.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-demi"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinia@2.1.7/dist/pinia.iife.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <!-- APPLICATION LOGIC -->
    <script>
        const { createApp, ref, computed, watch, onMounted, reactive, nextTick } = Vue;
        const { createPinia, defineStore } = Pinia;
        const { useQuasar } = Quasar;
        const { createI18n, useI18n } = VueI18n;

        // --- I18N MESSAGES ---
        const messages = {
            en: {
                ui: {
                    hangar: "Hangar", sheet: "Sheet", export: "Export", manifest: "Systems Manifest",
                    overview: "Overview", systems: "Systems", config: "Config", free_ep: "Free EP",
                    install_system: "Install System", install_caption: "Select category, type, and specific component.",
                    category: "Category", sys_type: "System Type", component: "Component",
                    non_standard: "Rare / Non-standard (Cost x5, EP x2)",
                    non_standard_tip: "Multiplies Cost by 5 and EP by 2 for ill-suited or rare modifications.",
                    ns_tag: "Non-Std", cost_variable: "Cost: Variable", base_cost: "Base Cost", base_ep: "Base EP",
                    avail: "Availability", variable: "Variable", size_mult_msg: "Includes {size} size multiplier",
                    cancel: "Cancel", install: "Install", new_stock: "New from Stock", import_file: "Import File",
                    upload_yaml: "Upload Ship YAML", select_file: "Select File", max_size: "Max Size",
                    engineering: "Engineering", designer: "Starship Designer", self_built: "Self-Built",
                    ledger: "Ledger", hull_base: "Hull Base", lic_fees: "Licensing Fees", total: "Total",
                    template: "Template", none: "None", chassis: "Chassis", market_avail: "Market Availability",
                    starship_designer_tip: "Waives Non-standard penalties. Enables custom modifications.",
                    installed_systems: "Installed Systems", print_btn: "Print to PDF / Paper"
                },
                stats: {
                    str: "STR", dex: "DEX", int: "INT", ref: "Reflex Defense", armor: "Armor",
                    hp: "HP", shields: "Shields", dr: "DR", speed: "Speed"
                },
                cat: {
                    fighters: "Fighters", freighters: "Freighters", capitals: "Capital Ships",
                    weapons: "Weapon Systems", movement: "Movement Systems", defense: "Defense Systems",
                    mods: "Modifications", accessories: "Starship Accessories"
                },
                avail: {
                    Common: "Common", Licensed: "Licensed", Restricted: "Restricted",
                    Military: "Military", Illegal: "Illegal"
                }
            },
            es: {
                ui: {
                    hangar: "Hangar", sheet: "Ficha", export: "Exportar", manifest: "Manifiesto de Sistemas",
                    overview: "Resumen", systems: "Sistemas", config: "Config", free_ep: "PE Libre",
                    install_system: "Instalar Sistema", install_caption: "Seleccione categoría, tipo y componente específico.",
                    category: "Categoría", sys_type: "Tipo de Sistema", component: "Componente",
                    non_standard: "Raro / No Estándar (Costo x5, PE x2)",
                    non_standard_tip: "Multiplica Costo por 5 y PE por 2 para modificaciones raras o inadecuadas.",
                    ns_tag: "No-Est", cost_variable: "Costo: Variable", base_cost: "Costo Base", base_ep: "PE Base",
                    avail: "Disponibilidad", variable: "Variable", size_mult_msg: "Incluye multiplicador de tamaño {size}",
                    cancel: "Cancelar", install: "Instalar", new_stock: "Nuevo de Stock", import_file: "Importar Archivo",
                    upload_yaml: "Subir YAML de Nave", select_file: "Seleccionar Archivo", max_size: "Tamaño Máx",
                    engineering: "Ingeniería", designer: "Diseñador de Naves", self_built: "Construcción Propia",
                    ledger: "Libro Mayor", hull_base: "Base del Casco", lic_fees: "Tasas de Licencia", total: "Total",
                    template: "Plantilla", none: "Ninguno", chassis: "Chasis", market_avail: "Disponibilidad de Mercado",
                    starship_designer_tip: "Anula penalizaciones No Estándar. Permite modificaciones personalizadas.",
                    installed_systems: "Sistemas Instalados", print_btn: "Imprimir en PDF / Papel"
                },
                stats: {
                    str: "FUE", dex: "DES", int: "INT", ref: "Defensa de Reflejos", armor: "Armadura",
                    hp: "PV", shields: "Escudos", dr: "RD", speed: "Velocidad"
                },
                cat: {
                    fighters: "Cazas", freighters: "Cargueros", capitals: "Naves Capitales",
                    weapons: "Sistemas de Armas", movement: "Sistemas de Movimiento", defense: "Sistemas Defensivos",
                    mods: "Modificaciones", accessories: "Accesorios"
                },
                avail: {
                    Common: "Común", Licensed: "Licenciado", Restricted: "Restringido",
                    Military: "Militar", Illegal: "Ilegal"
                }
            }
        };
        
        const i18n = createI18n({ locale: 'en', fallbackLocale: 'en', messages, legacy: false });
        
        // Helper accessible globally within module
        const getLocalizedName = (item) => {
            if (!item) return '';
            return i18n.global.locale.value === 'es' && item.name_es ? item.name_es : item.name;
        };

        // Constants
        const SIZE_COST_MULTIPLIERS = { 'Tiny': 1, 'Small': 1, 'Medium': 1, 'Large': 1, 'Huge': 1, 'Gargantuan': 2, 'Colossal': 5, 'Colossal (frigate)': 50, 'Colossal (cruiser)': 500, 'Colossal (station)': 5000 };
        const REFLEX_SIZE_MODS = { 'Colossal (cruiser)': -10, 'Colossal (frigate)': -10, 'Colossal': -10, 'Gargantuan': -5, 'Huge': -2, 'Large': -1, 'Medium': 0, 'Small': 1, 'Tiny': 2 };
        const MAX_SR_BY_SIZE = { 'Tiny': 15, 'Small': 20, 'Medium': 30, 'Large': 40, 'Huge': 50, 'Gargantuan': 60, 'Colossal': 55, 'Colossal (frigate)': 150, 'Colossal (cruiser)': 250 };
        const LICENSE_FEES = { 'Common': 0, 'Licensed': 0.05, 'Restricted': 0.10, 'Military': 0.20, 'Illegal': 0.50 };
        const AVAILABILITY_RANK = ['Common', 'Licensed', 'Restricted', 'Military', 'Illegal'];
        const SIZE_RANK = ['Tiny', 'Small', 'Medium', 'Large', 'Huge', 'Gargantuan', 'Colossal', 'Colossal (frigate)', 'Colossal (cruiser)', 'Colossal (station)'];

        // --- DATA ASSETS (With ES Translations) ---
        const STOCK_SHIPS = [
            { 
                id: 'light_fighter', name: 'Light Fighter', name_es: 'Caza Ligero', size: 'Huge', cost: 30000, baseEp: 2, 
                stats: { str: 34, dex: 20, int: 14, hp: 60, dr: 10, armor: 3, sr: 0 },
                logistics: { crew: 1, pass: 0, cargo: '50 kg', cons: '2 days' },
                defaultMods: ['engine_5'] 
            },
            { 
                id: 'interceptor', name: 'Interceptor', name_es: 'Interceptor', size: 'Huge', cost: 100000, baseEp: 5, 
                stats: { str: 38, dex: 24, int: 14, hp: 90, dr: 10, armor: 3, sr: 0 },
                logistics: { crew: 1, pass: 0, cargo: '50 kg', cons: '2 days' },
                defaultMods: ['engine_6'] 
            },
            { 
                id: 'superiority_fighter', name: 'Superiority Fighter', name_es: 'Caza de Superioridad', size: 'Gargantuan', cost: 50000, baseEp: 5, 
                stats: { str: 42, dex: 22, int: 14, hp: 120, dr: 10, armor: 7, sr: 0 },
                logistics: { crew: 1, pass: 0, cargo: '50 kg', cons: '2 days' },
                defaultMods: ['engine_4', 'hyperdrive_1', 'shield_gen_15', 'nav_standard']
            },
            { id: 'bomber', name: 'Bomber', name_es: 'Bombardero', size: 'Gargantuan', cost: 50000, baseEp: 10, stats: { str: 46, dex: 18, int: 14, hp: 150, dr: 10, armor: 8, sr: 0 }, logistics: { crew: 2, pass: 0, cargo: '50 kg', cons: '2 days' }, defaultMods: ['engine_3', 'hyperdrive_1', 'shield_gen_10', 'nav_standard'] },
            { id: 'gunship', name: 'Gunship', name_es: 'Cañonera', size: 'Colossal', cost: 200000, baseEp: 20, stats: { str: 50, dex: 14, int: 16, hp: 150, dr: 15, armor: 12, sr: 0 }, logistics: { crew: 4, pass: 4, cargo: '5 tons', cons: '1 month' }, defaultMods: ['engine_3', 'shield_gen_20'] },
            { id: 'shuttle', name: 'Shuttle', name_es: 'Lanzadera', size: 'Colossal', cost: 50000, baseEp: 5, stats: { str: 46, dex: 14, int: 14, hp: 120, dr: 15, armor: 12, sr: 0 }, logistics: { crew: 4, pass: 8, cargo: '20 tons', cons: '1 month' }, defaultMods: ['engine_3', 'hyperdrive_1', 'shield_gen_20', 'nav_standard'] },
            { id: 'light_freighter', name: 'Light Freighter', name_es: 'Carguero Ligero', size: 'Colossal', cost: 20000, baseEp: 5, stats: { str: 42, dex: 10, int: 12, hp: 120, dr: 15, armor: 12, sr: 0 }, logistics: { crew: 2, pass: 6, cargo: '100 tons', cons: '2 months' }, defaultMods: ['engine_2', 'hyperdrive_2', 'shield_gen_15', 'nav_standard'] },
            { id: 'heavy_freighter', name: 'Heavy Freighter', name_es: 'Carguero Pesado', size: 'Colossal (frigate)', cost: 500000, baseEp: 5, stats: { str: 106, dex: 10, int: 12, hp: 400, dr: 15, armor: 12, sr: 0 }, logistics: { crew: 10, pass: 10, cargo: '100,000 tons', cons: '6 months' }, defaultMods: ['engine_1', 'hyperdrive_2', 'shield_gen_20', 'nav_standard'] },
            { id: 'corvette', name: 'Corvette', name_es: 'Corbeta', size: 'Colossal (frigate)', cost: 1000000, baseEp: 20, stats: { str: 110, dex: 18, int: 16, hp: 600, dr: 15, armor: 12, sr: 0 }, logistics: { crew: 50, pass: 200, cargo: '2,000 tons', cons: '1 year' }, defaultMods: ['engine_3', 'hyperdrive_2', 'shield_gen_30', 'nav_standard'] },
            { id: 'frigate', name: 'Frigate', name_es: 'Fragata', size: 'Colossal (frigate)', cost: 2000000, baseEp: 50, stats: { str: 114, dex: 16, int: 16, hp: 800, dr: 15, armor: 12, sr: 0 }, logistics: { crew: 1000, pass: 200, cargo: '5,000 tons', cons: '1 year' }, defaultMods: ['engine_2', 'hyperdrive_2', 'shield_gen_30', 'nav_standard'] },
            { id: 'cruiser', name: 'Cruiser', name_es: 'Crucero', size: 'Colossal (cruiser)', cost: 10000000, baseEp: 100, stats: { str: 118, dex: 14, int: 16, hp: 1500, dr: 20, armor: 14, sr: 0 }, logistics: { crew: 5000, pass: 1000, cargo: '10,000 tons', cons: '2 years' }, defaultMods: ['engine_2', 'hyperdrive_2', 'shield_gen_40', 'nav_standard'] },
            { id: 'battlecruiser', name: 'Battlecruiser', name_es: 'Crucero de Batalla', size: 'Colossal (cruiser)', cost: 20000000, baseEp: 200, stats: { str: 124, dex: 12, int: 18, hp: 2000, dr: 20, armor: 16, sr: 0 }, logistics: { crew: 20000, pass: 5000, cargo: '20,000 tons', cons: '2 years' }, defaultMods: ['engine_2', 'hyperdrive_1', 'shield_gen_60', 'nav_standard'] },
            
            // CITADEL CLASS (Corrected Stats)
            { 
                id: 'citadel', name: 'Citadel-class Cruiser', name_es: 'Crucero clase Ciudadela', size: 'Colossal', cost: 205000, baseEp: 30, 
                stats: { str: 42, dex: 12, int: 12, hp: 120, dr: 15, armor: 14, sr: 0 }, 
                logistics: { crew: 3, pass: 14, cargo: '50 tons', cons: '6 months' }, 
                // Speed 3, Hyp 2, SR 30, Nav, Twin Med Laser, 2x Ion, Missiles, Tractor, 2x Clamps
                defaultMods: [
                    'engine_3', 'hyperdrive_2', 'shield_gen_30', 'nav_standard',
                    'laser_med_twin', 'ion_cannon', 'ion_cannon', 'concussion_missile', 'tractor_beam',
                    'docking_clamp', 'docking_clamp', 'escape_pod', 'escape_pod', 'holo_transceiver'
                ] 
            }
        ];

        const TEMPLATES = [
            { id: 'advanced', name: 'Advanced', name_es: 'Avanzado', costMult: 1.25, epMod: 0, stats: { dex: 4, hp: 20, sr: 10 } },
            { id: 'prototype', name: 'Prototype', name_es: 'Prototipo', costMult: 0.5, epMod: 0, stats: { hp: -20, sr: -10 } },
            { id: 'ancient', name: 'Ancient', name_es: 'Antiguo', costMult: 0.8, epMod: -2, stats: { dr: -2 } }
        ];

        const EQUIPMENT = [
            // WEAPON SYSTEMS - LASERS
            // Light (Base: Licensed, 1 EP)
            { id: 'laser_light', name: 'Light Laser Cannon (3d10x2)', name_es: 'Cañón Láser Ligero (3d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 1000, baseEp: 1, sizeMult: false, availability: 'Licensed' },
            { id: 'laser_light_twin', name: 'Twin Light Laser Cannon (4d10x2)', name_es: 'Cañón Láser Ligero Doble (4d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 3000, baseEp: 1, sizeMult: false, availability: 'Licensed' },
            { id: 'laser_light_quad', name: 'Quad Light Laser Cannon (5d10x2)', name_es: 'Cañón Láser Ligero Cuádruple (5d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 5000, baseEp: 2, sizeMult: false, availability: 'Restricted' },

            // Medium (Base: Restricted, 1 EP)
            { id: 'laser_med', name: 'Medium Laser Cannon (4d10x2)', name_es: 'Cañón Láser Mediano (4d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 2500, baseEp: 1, sizeMult: false, availability: 'Restricted' },
            { id: 'laser_med_twin', name: 'Twin Medium Laser Cannon (5d10x2)', name_es: 'Cañón Láser Mediano Doble (5d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 7500, baseEp: 1, sizeMult: false, availability: 'Restricted' },
            { id: 'laser_med_quad', name: 'Quad Medium Laser Cannon (6d10x2)', name_es: 'Cañón Láser Mediano Cuádruple (6d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 12500, baseEp: 2, sizeMult: false, availability: 'Restricted' },

            // Heavy (Base: Military, 2 EP)
            { id: 'laser_hvy', name: 'Heavy Laser Cannon (5d10x2)', name_es: 'Cañón Láser Pesado (5d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 4000, baseEp: 2, sizeMult: false, availability: 'Military' },
            { id: 'laser_hvy_twin', name: 'Twin Heavy Laser Cannon (6d10x2)', name_es: 'Cañón Láser Pesado Doble (6d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 12000, baseEp: 2, sizeMult: false, availability: 'Military' },
            { id: 'laser_hvy_quad', name: 'Quad Heavy Laser Cannon (7d10x2)', name_es: 'Cañón Láser Pesado Cuádruple (7d10x2)', category: 'Weapon Systems', group: 'Laser Cannons', type: 'weapon', baseCost: 20000, baseEp: 3, sizeMult: false, availability: 'Military' },

            // Other Weapons
            { id: 'turbolaser', name: 'Turbolaser', name_es: 'Turboláser', category: 'Weapon Systems', group: 'Turbolasers', type: 'weapon', baseCost: 10000, baseEp: 5, sizeMult: true, availability: 'Military' },
            { id: 'proton_torp', name: 'Proton Torpedo Launcher', name_es: 'Lanzador de Torpedos de Protones', category: 'Weapon Systems', group: 'Launchers', type: 'weapon', baseCost: 3000, baseEp: 1, sizeMult: false, availability: 'Restricted' },
            { id: 'ion_cannon', name: 'Ion Cannon', name_es: 'Cañón de Iones', category: 'Weapon Systems', group: 'Ion Weapons', type: 'weapon', baseCost: 5000, baseEp: 1, sizeMult: false, availability: 'Restricted' },
            { id: 'concussion_missile', name: 'Concussion Missile Launcher', name_es: 'Lanzador de Misiles de Concusión', category: 'Weapon Systems', group: 'Launchers', type: 'weapon', baseCost: 6000, baseEp: 1, sizeMult: false, availability: 'Restricted' },
            { id: 'tractor_beam', name: 'Tractor Beam', name_es: 'Rayo Tractor', category: 'Weapon Systems', group: 'Tactical', type: 'weapon', baseCost: 10000, baseEp: 1, sizeMult: false, availability: 'Common' },
            
            // MOVEMENT
            { id: 'atmos_thrusters', name: 'Atmospheric Thrusters', name_es: 'Propulsores Atmosféricos', category: 'Movement Systems', group: 'Thrusters', type: 'system', baseCost: 2000, baseEp: 2, sizeMult: false, maxSize: 'Colossal', availability: 'Common' },
            { id: 'atmos_thrusters_adv', name: 'Atmospheric Thrusters, Adv', name_es: 'Propulsores Atmosféricos, Avz', category: 'Movement Systems', group: 'Thrusters', type: 'system', baseCost: 5000, baseEp: 5, sizeMult: false, maxSize: 'Gargantuan', availability: 'Common' },
            { id: 'combat_thrusters', name: 'Combat Thrusters', name_es: 'Propulsores de Combate', category: 'Movement Systems', group: 'Thrusters', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: false, maxSize: 'Colossal', availability: 'Common' },
            { id: 'maneuver_2', name: 'Maneuvering Jets (+2)', name_es: 'Jets de Maniobra (+2)', category: 'Movement Systems', group: 'Thrusters', type: 'system', baseCost: 2000, baseEp: 2, sizeMult: false, stats: { pilot_bonus: 2 }, availability: 'Common' },
            { id: 'maneuver_4', name: 'Maneuvering Jets (+4)', name_es: 'Jets de Maniobra (+4)', category: 'Movement Systems', group: 'Thrusters', type: 'system', baseCost: 5000, baseEp: 3, sizeMult: false, stats: { pilot_bonus: 4 }, maxSize: 'Colossal', availability: 'Common' },
            { id: 'maneuver_6', name: 'Maneuvering Jets (+6)', name_es: 'Jets de Maniobra (+6)', category: 'Movement Systems', group: 'Thrusters', type: 'system', baseCost: 10000, baseEp: 4, sizeMult: false, stats: { pilot_bonus: 6 }, maxSize: 'Gargantuan', availability: 'Licensed' },
            
            // HYPERDRIVES
            { id: 'hyperdrive_075', name: 'Hyperdrive Class .75', name_es: 'Hiperimpulsor Clase .75', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 5000, baseEp: 4, sizeMult: true, stats: { hyperdrive: 0.75 }, maxSize: 'Colossal (cruiser)', availability: 'Military' },
            { id: 'hyperdrive_1', name: 'Hyperdrive Class 1', name_es: 'Hiperimpulsor Clase 1', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 3000, baseEp: 3, sizeMult: true, stats: { hyperdrive: 1 }, maxSize: 'Colossal (cruiser)', availability: 'Licensed' },
            { id: 'hyperdrive_15', name: 'Hyperdrive Class 1.5', name_es: 'Hiperimpulsor Clase 1.5', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 2500, baseEp: 3, sizeMult: true, stats: { hyperdrive: 1.5 }, maxSize: 'Colossal (cruiser)', availability: 'Licensed' },
            { id: 'hyperdrive_2', name: 'Hyperdrive Class 2', name_es: 'Hiperimpulsor Clase 2', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 2000, baseEp: 3, sizeMult: true, stats: { hyperdrive: 2 }, availability: 'Common' },
            { id: 'hyperdrive_3', name: 'Hyperdrive Class 3', name_es: 'Hiperimpulsor Clase 3', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 1500, baseEp: 2, sizeMult: true, stats: { hyperdrive: 3 }, availability: 'Common' },
            { id: 'hyperdrive_4', name: 'Hyperdrive Class 4', name_es: 'Hiperimpulsor Clase 4', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 1000, baseEp: 2, sizeMult: true, stats: { hyperdrive: 4 }, availability: 'Common' },
            { id: 'hyperdrive_6', name: 'Hyperdrive Class 6', name_es: 'Hiperimpulsor Clase 6', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 400, baseEp: 2, sizeMult: true, stats: { hyperdrive: 6 }, availability: 'Common' },
            { id: 'hyperdrive_15_slow', name: 'Hyperdrive Class 15', name_es: 'Hiperimpulsor Clase 15', category: 'Movement Systems', group: 'Hyperdrives', type: 'system', baseCost: 100, baseEp: 1, sizeMult: true, stats: { hyperdrive: 15 }, availability: 'Common' },
            { id: 'nav_standard', name: 'Navicomputer', name_es: 'Navicomputadora', category: 'Movement Systems', group: 'Navigation', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: false, availability: 'Licensed' },
            { id: 'nav_limited', name: 'Navicomputer (Limited)', name_es: 'Navicomputadora (Limitada)', category: 'Movement Systems', group: 'Navigation', type: 'system', baseCost: 500, baseEp: 0, sizeMult: false, availability: 'Common' },
            { id: 'nav_advanced', name: 'Navicomputer (Advanced)', name_es: 'Navicomputadora (Avanzada)', category: 'Movement Systems', group: 'Navigation', type: 'system', baseCost: 20000, baseEp: 2, sizeMult: false, availability: 'Licensed' },
            { id: 'slam', name: 'SubLight Accelerator Motor', name_es: 'Motor Acelerador Subluz', category: 'Movement Systems', group: 'Sublight Drives', type: 'system', baseCost: 25000, baseEp: 2, sizeMult: false, maxSize: 'Gargantuan', availability: 'Military' },
            
            // SUBLIGHT
            { id: 'engine_1', name: 'Sublight Drive (Speed 1)', name_es: 'Motor Subluz (Velocidad 1)', category: 'Movement Systems', group: 'Sublight Drives', type: 'engine', baseCost: 1000, baseEp: 2, sizeMult: true, stats: { speed: 1 }, exclusiveGroup: 'engine', availability: 'Common' },
            { id: 'engine_2', name: 'Sublight Drive (Speed 2)', name_es: 'Motor Subluz (Velocidad 2)', category: 'Movement Systems', group: 'Sublight Drives', type: 'engine', baseCost: 2000, baseEp: 3, sizeMult: true, stats: { speed: 2 }, exclusiveGroup: 'engine', availability: 'Common' },
            { id: 'engine_3', name: 'Sublight Drive (Speed 3)', name_es: 'Motor Subluz (Velocidad 3)', category: 'Movement Systems', group: 'Sublight Drives', type: 'engine', baseCost: 5000, baseEp: 4, sizeMult: true, stats: { speed: 3 }, exclusiveGroup: 'engine', maxSize: 'Colossal (cruiser)', availability: 'Licensed' },
            { id: 'engine_4', name: 'Sublight Drive (Speed 4)', name_es: 'Motor Subluz (Velocidad 4)', category: 'Movement Systems', group: 'Sublight Drives', type: 'engine', baseCost: 10000, baseEp: 5, sizeMult: true, stats: { speed: 4 }, exclusiveGroup: 'engine', maxSize: 'Colossal (cruiser)', availability: 'Restricted' },
            { id: 'engine_5', name: 'Sublight Drive (Speed 5)', name_es: 'Motor Subluz (Velocidad 5)', category: 'Movement Systems', group: 'Sublight Drives', type: 'engine', baseCost: 20000, baseEp: 6, sizeMult: true, stats: { speed: 5 }, exclusiveGroup: 'engine', maxSize: 'Colossal', availability: 'Military' },
            { id: 'engine_6', name: 'Sublight Drive (Speed 6)', name_es: 'Motor Subluz (Velocidad 6)', category: 'Movement Systems', group: 'Sublight Drives', type: 'engine', baseCost: 100000, baseEp: 7, sizeMult: true, stats: { speed: 6 }, exclusiveGroup: 'engine', maxSize: 'Gargantuan', availability: 'Military' },
            
            // DEFENSE
            { id: 'shield_gen_5', name: 'Shield Generator (SR 5)', name_es: 'Generador de Escudos (SR 5)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 500, baseEp: 1, sizeMult: true, stats: { sr: 5 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_10', name: 'Shield Generator (SR 10)', name_es: 'Generador de Escudos (SR 10)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: true, stats: { sr: 10 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_15', name: 'Shield Generator (SR 15)', name_es: 'Generador de Escudos (SR 15)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 5000, baseEp: 2, sizeMult: true, stats: { sr: 15 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_20', name: 'Shield Generator (SR 20)', name_es: 'Generador de Escudos (SR 20)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 10000, baseEp: 3, sizeMult: true, stats: { sr: 20 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_25', name: 'Shield Generator (SR 25)', name_es: 'Generador de Escudos (SR 25)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 12000, baseEp: 4, sizeMult: true, stats: { sr: 25 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_30', name: 'Shield Generator (SR 30)', name_es: 'Generador de Escudos (SR 30)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 15000, baseEp: 5, sizeMult: true, stats: { sr: 30 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_35', name: 'Shield Generator (SR 35)', name_es: 'Generador de Escudos (SR 35)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 20000, baseEp: 6, sizeMult: true, stats: { sr: 35 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_40', name: 'Shield Generator (SR 40)', name_es: 'Generador de Escudos (SR 40)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 25000, baseEp: 7, sizeMult: true, stats: { sr: 40 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_45', name: 'Shield Generator (SR 45)', name_es: 'Generador de Escudos (SR 45)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 30000, baseEp: 8, sizeMult: true, stats: { sr: 45 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_50', name: 'Shield Generator (SR 50)', name_es: 'Generador de Escudos (SR 50)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 40000, baseEp: 9, sizeMult: true, stats: { sr: 50 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_55', name: 'Shield Generator (SR 55)', name_es: 'Generador de Escudos (SR 55)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 50000, baseEp: 10, sizeMult: true, stats: { sr: 55 }, exclusiveGroup: 'shield', availability: 'Common' },
            { id: 'shield_gen_60', name: 'Shield Generator (SR 60)', name_es: 'Generador de Escudos (SR 60)', category: 'Defense Systems', group: 'Shield Generators', type: 'system', baseCost: 60000, baseEp: 11, sizeMult: true, stats: { sr: 60 }, exclusiveGroup: 'shield', availability: 'Common' },

            { id: 'bulkheads', name: 'Reinforced Bulkheads (+10% HP)', name_es: 'Mamparos Reforzados (+10% PV)', category: 'Defense Systems', group: 'Armor', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: true, stats: { hp_bonus_pct: 0.10 }, availability: 'Licensed' },
            { id: 'jamming', name: 'Jamming Suite', name_es: 'Suite de Interferencias', category: 'Defense Systems', group: 'Electronic Warfare', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: false, availability: 'Restricted' },
            { id: 'ecm_suite', name: 'Electronic Countermeasures (ECM)', name_es: 'Contramedidas Electrónicas (ECM)', category: 'Defense Systems', group: 'Electronic Warfare', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: true, availability: 'Military' },
            { id: 'cloaking', name: 'Cloaking Device', name_es: 'Dispositivo de Camuflaje', category: 'Defense Systems', group: 'Electronic Warfare', type: 'system', baseCost: 100000, baseEp: 5, sizeMult: true, availability: 'Illegal' },
            { id: 'anti_concussion', name: 'Anti-Concussion Field', name_es: 'Campo Anticoncusión', category: 'Defense Systems', group: 'Shields', type: 'system', baseCost: 5000, baseEp: 5, sizeMult: true, availability: 'Military' },
            { id: 'aux_gen', name: 'Auxiliary Generator', name_es: 'Generador Auxiliar', category: 'Defense Systems', group: 'Generators', type: 'system', baseCost: 0, baseEp: 1, sizeMult: false, stats: { cost_dynamic_pct: 0.10 }, availability: 'Common' },
            { id: 'backup_shield', name: 'Backup Shield Generator', name_es: 'Generador de Escudos de Respaldo', category: 'Defense Systems', group: 'Shields', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: true, availability: 'Common' },

            // MODIFICATIONS
            { id: 'tech_spec_sh', name: 'Tech Spec: Shields (+10 SR)', name_es: 'Esp. Tec: Escudos (+10 SR)', category: 'Modifications', group: 'Tech Specialist', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { sr_bonus: 10 }, exclusiveGroup: 'tech_spec', availability: 'Common', variableCost: true },
            { id: 'tech_spec_ar', name: 'Tech Spec: Armor (+2)', name_es: 'Esp. Tec: Armadura (+2)', category: 'Modifications', group: 'Tech Specialist', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { armor_bonus: 2 }, exclusiveGroup: 'tech_spec', availability: 'Common', variableCost: true },
            { id: 'ts_dex', name: 'Enhanced Dexterity (+2 Dex)', category: 'Modifications', group: 'Tech Specialist', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { dex_bonus: 2 }, exclusiveGroup: 'tech_spec', availability: 'Common', variableCost: true },
            { id: 'ts_speed', name: 'Improved Speed (+25%)', category: 'Modifications', group: 'Tech Specialist', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { speed_factor: 0.25 }, exclusiveGroup: 'tech_spec', availability: 'Common', variableCost: true },
            { id: 'sup_tech_sh', name: 'Shields (+20 SR)', category: 'Modifications', group: 'Superior Tech', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { sr_bonus: 20 }, exclusiveGroup: 'superior_tech', availability: 'Rare', variableCost: true },
            { id: 'sup_tech_ar', name: 'Armor (+2 Armor)', category: 'Modifications', group: 'Superior Tech', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { armor_bonus: 2 }, exclusiveGroup: 'superior_tech', availability: 'Rare', variableCost: true },
            { id: 'st_dex', name: 'Superior Dex (+4 Dex)', category: 'Modifications', group: 'Superior Tech', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { dex_bonus: 4 }, exclusiveGroup: 'superior_tech', availability: 'Rare', variableCost: true },
            { id: 'st_str', name: 'Superior Str (+2 Str)', category: 'Modifications', group: 'Superior Tech', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { str_bonus: 2 }, exclusiveGroup: 'superior_tech', availability: 'Rare', variableCost: true },
            { id: 'st_sensors', name: 'Superior Sensors (+2 Per)', category: 'Modifications', group: 'Superior Tech', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { perception_bonus: 2 }, exclusiveGroup: 'superior_tech', availability: 'Rare', variableCost: true },
            { id: 'st_speed', name: 'Superior Speed (+33%)', category: 'Modifications', group: 'Superior Tech', type: 'upgrade', baseCost: 0, baseEp: 0, sizeMult: false, stats: { speed_factor: 0.333 }, exclusiveGroup: 'superior_tech', availability: 'Rare', variableCost: true },
            { id: 'mod_cargo_10', name: 'Cargo Config (-25% Cargo)', name_es: 'Config. Carga (-25% Carga)', category: 'Modifications', group: 'Hull Config', type: 'modification', baseCost: 0, baseEp: 0, stats: { ep_dynamic_pct: -0.10, cargo_factor: 0.75 }, exclusiveGroup: 'cargo_mod', availability: 'Common', variableCost: true },
            { id: 'mod_cargo_20', name: 'Cargo Config (-50% Cargo)', name_es: 'Config. Carga (-50% Carga)', category: 'Modifications', group: 'Hull Config', type: 'modification', baseCost: 0, baseEp: 0, stats: { ep_dynamic_pct: -0.20, cargo_factor: 0.50 }, exclusiveGroup: 'cargo_mod', availability: 'Common', variableCost: true },
            { id: 'sd_emplacement', name: 'Add Emplacement Point', name_es: 'Añadir Punto de Emplazamiento', category: 'Modifications', group: 'Starship Designer', type: 'modification', baseCost: 5000, baseEp: -1, sizeMult: true, availability: 'Common', variableCost: true },
            { id: 'sd_shields', name: 'Improve Shields (+5 SR)', name_es: 'Mejorar Escudos (+5 SR)', category: 'Modifications', group: 'Starship Designer', type: 'modification', baseCost: 5000, baseEp: 0, sizeMult: true, stats: { sr_bonus: 5 }, availability: 'Common', variableCost: true },
            { id: 'sd_hull', name: 'Improve Hull (+HP)', name_es: 'Mejorar Casco (+PV)', category: 'Modifications', group: 'Starship Designer', type: 'modification', baseCost: 5000, baseEp: 0, sizeMult: true, stats: { hp_dynamic_str: true }, availability: 'Common', variableCost: true },
            { id: 'sd_nav', name: 'Improve Hyperdrive (-1 Class)', name_es: 'Mejorar Hiperimpulsor (-1 Clase)', category: 'Modifications', group: 'Starship Designer', type: 'modification', baseCost: 5000, baseEp: 0, sizeMult: true, stats: { hyperdrive_bonus: -1 }, availability: 'Common', variableCost: true },
            { id: 'sd_weap', name: 'Improve Weapon (+1 Atk)', name_es: 'Mejorar Arma (+1 Atq)', category: 'Modifications', group: 'Starship Designer', type: 'modification', baseCost: 5000, baseEp: 0, sizeMult: true, availability: 'Common', variableCost: true },

            // ACCESSORIES (Added as requested)
            { id: 'backup_battery', name: 'Backup Battery', name_es: 'Batería de Respaldo', category: 'Starship Accessories', group: 'Power', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: false, availability: 'Common' },
            { id: 'holo_transceiver', name: 'HoloNet Transceiver', name_es: 'Transceptor HoloNet', category: 'Starship Accessories', group: 'Communications', type: 'system', baseCost: 10000, baseEp: 1, sizeMult: false, availability: 'Common' },
            { id: 'escape_pod', name: 'Escape Pod (4 beings)', name_es: 'Cápsula de Escape (4 seres)', category: 'Starship Accessories', group: 'Safety', type: 'system', baseCost: 1000, baseEp: 1, sizeMult: false, availability: 'Common' },
            { id: 'medical_bed', name: 'Medical Bed', name_es: 'Cama Médica', category: 'Starship Accessories', group: 'Accommodations', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: false, availability: 'Common' },
            { id: 'medical_suite', name: 'Medical Suite', name_es: 'Suite Médica', category: 'Starship Accessories', group: 'Accommodations', type: 'system', baseCost: 5000, baseEp: 2, sizeMult: false, availability: 'Common' },
            { id: 'passenger_seating', name: 'Passenger Seating (1 seat)', name_es: 'Asiento de Pasajero', category: 'Starship Accessories', group: 'Accommodations', type: 'system', baseCost: 200, baseEp: 0, sizeMult: false, availability: 'Common' },
            { id: 'slave_circuits', name: 'Slave Circuits', name_es: 'Circuitos Esclavos', category: 'Starship Accessories', group: 'Control', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: true, availability: 'Restricted' },
            { id: 'smuggling_compartment', name: 'Smuggling Compartment', name_es: 'Compartimento de Contrabando', category: 'Starship Accessories', group: 'Storage', type: 'system', baseCost: 1000, baseEp: 1, sizeMult: true, availability: 'Illegal' },
            { id: 'cargo_pod', name: 'Cargo Pod (10 tons)', name_es: 'Módulo de Carga (10 tons)', category: 'Starship Accessories', group: 'Storage', type: 'cargo', baseCost: 1000, baseEp: 1, sizeMult: false, availability: 'Common' },
            { id: 'cryo_chambers', name: 'Cryogenic Chambers (10 units)', name_es: 'Cámaras Criogénicas (10 uds)', category: 'Starship Accessories', group: 'Accommodations', type: 'cargo', baseCost: 5000, baseEp: 1, sizeMult: false, availability: 'Common' },
            { id: 'docking_clamp', name: 'Docking Clamp', name_es: 'Pinza de Acoplamiento', category: 'Starship Accessories', group: 'Docking', type: 'system', baseCost: 2000, baseEp: 1, sizeMult: false, availability: 'Common' }
        ];

        const useShipStore = defineStore('ship', () => {
            const meta = reactive({ name: 'Untitled Ship', version: '1.0' });
            const chassisId = ref('light_fighter');
            const activeTemplate = ref(null); 
            const installedMods = ref([]); 
            const engineering = reactive({ hasStarshipDesigner: false }); 
            const showAddModDialog = ref(false);

            // Helper functions defined before use
            function getModEp(mod) {
                const def = EQUIPMENT.find(e => e.id === mod.defId);
                if (!def || mod.isStock) return 0;

                let epCost = def.baseEp;
                // Dynamic EP (Gain)
                if (def.stats && def.stats.ep_dynamic_pct) {
                    epCost = Math.floor(chassis.value.baseEp * def.stats.ep_dynamic_pct); 
                }

                // Non-Standard Logic (New)
                if (mod.isNonStandard && epCost > 0) {
                    epCost *= 2;
                }

                // Miniaturization
                if (epCost > 0) {
                    if (mod.miniaturization === 1) epCost = Math.max(1, epCost - 1);
                    else if (mod.miniaturization === 2) epCost = Math.ceil(epCost / 2);
                }
                return epCost;
            }

            function getModCost(mod) {
                const def = EQUIPMENT.find(e => e.id === mod.defId);
                if (!def || mod.isStock) return 0;

                let cost = def.baseCost;
                if (def.sizeMult) cost *= sizeMultVal.value;
                if (mod.miniaturization === 1) cost *= 2;
                else if (mod.miniaturization === 2) cost *= 5;
                
                // Apply Non-Standard Multiplier
                if (mod.isNonStandard) cost *= 5;

                return cost;
            }

            const chassis = computed(() => STOCK_SHIPS.find(s => s.id === chassisId.value) || STOCK_SHIPS[0]);
            const template = computed(() => activeTemplate.value ? TEMPLATES.find(t => t.id === activeTemplate.value) : null);
            const templateCostMult = computed(() => template.value ? template.value.costMult : 1);
            const sizeMultVal = computed(() => SIZE_COST_MULTIPLIERS[chassis.value.size] || 1);
            
            const currentStats = computed(() => {
                const s = { ...chassis.value.stats, speed: 0 };
                if (template.value && template.value.stats) {
                    for (const [key, val] of Object.entries(template.value.stats)) if (s[key] !== undefined) s[key] += val;
                }
                let modSR = null, bestHyperdrive = null;
                let bonusSR = 0, bonusArmor = 0, bonusHP = 0;
                let bonusDex = 0, bonusStr = 0, bonusPer = 0, speedFactor = 0, hyperdriveShift = 0;
                let hpBonusPct = 0;

                installedMods.value.forEach(mod => {
                    const def = EQUIPMENT.find(e => e.id === mod.defId);
                    if (def && def.stats) {
                        if (def.stats.sr !== undefined) modSR = def.stats.sr;
                        if (def.stats.hyperdrive !== undefined) {
                             if (bestHyperdrive === null || def.stats.hyperdrive < bestHyperdrive) {
                                bestHyperdrive = def.stats.hyperdrive;
                            }
                        }
                        if (def.stats.speed !== undefined) s.speed = def.stats.speed;
                        
                        if (def.stats.sr_bonus) bonusSR += def.stats.sr_bonus;
                        if (def.stats.armor_bonus) bonusArmor += def.stats.armor_bonus;
                        if (def.stats.dex_bonus) bonusDex += def.stats.dex_bonus;
                        if (def.stats.str_bonus) bonusStr += def.stats.str_bonus;
                        if (def.stats.perception_bonus) bonusPer += def.stats.perception_bonus;
                        if (def.stats.speed_factor) speedFactor += def.stats.speed_factor;
                        if (def.stats.hyperdrive_bonus) hyperdriveShift += def.stats.hyperdrive_bonus;
                        if (def.stats.hp_dynamic_str) bonusHP += Math.floor(Math.floor((s.str || 0) / 2) / 10) * 10;
                        if (def.stats.hp_bonus_pct) hpBonusPct += def.stats.hp_bonus_pct;
                    }
                });
                if (modSR !== null) s.sr = modSR;
                if (bestHyperdrive !== null) s.hyperdrive = bestHyperdrive;

                s.sr += bonusSR; s.armor += bonusArmor; s.hp += bonusHP;
                s.dex += bonusDex; s.str += bonusStr; s.perception_bonus = bonusPer;
                if (hpBonusPct > 0) s.hp += Math.floor(s.hp * hpBonusPct);
                if (s.speed > 0 && speedFactor > 0) s.speed += Math.max(1, Math.floor(s.speed * speedFactor));
                if (s.hyperdrive) s.hyperdrive += hyperdriveShift;
                return s;
            });

            const shipAvailability = computed(() => {
                let maxRank = 0;
                installedMods.value.forEach(mod => {
                    const def = EQUIPMENT.find(e => e.id === mod.defId);
                    if (def && def.availability) {
                        const rank = AVAILABILITY_RANK.indexOf(def.availability);
                        if (rank > maxRank) maxRank = rank;
                    }
                });
                return AVAILABILITY_RANK[maxRank];
            });

            const maxSrAllowed = computed(() => MAX_SR_BY_SIZE[chassis.value.size] || 999);
            const isSrIllegal = computed(() => currentStats.value.sr > maxSrAllowed.value);
            const reflexDefense = computed(() => {
                const dexMod = Math.floor(((currentStats.value.dex || 10) - 10) / 2);
                const armor = currentStats.value.armor || 0;
                const sizeMod = REFLEX_SIZE_MODS[chassis.value.size] || 0;
                return 10 + dexMod + armor + sizeMod;
            });
            const currentCargo = computed(() => {
                const baseStr = chassis.value.logistics.cargo;
                if (!baseStr) return '0 kg';
                const match = baseStr.match(/([\d,]+)\s*(tons|kg)/i);
                if (!match) return baseStr;
                let val = parseFloat(match[1].replace(/,/g, ''));
                const unit = match[2];
                let multiplier = 1.0;
                installedMods.value.forEach(mod => {
                    const def = EQUIPMENT.find(e => e.id === mod.defId);
                    if (def && def.stats && def.stats.cargo_factor) multiplier = def.stats.cargo_factor;
                });
                val = val * multiplier;
                return new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(val) + ' ' + unit;
            });
            const totalEP = computed(() => {
                let ep = chassis.value.baseEp;
                if(template.value) ep += (template.value.epMod || 0);
                return ep;
            });
            const usedEP = computed(() => installedMods.value.reduce((total, mod) => total + getModEp(mod), 0));
            const remainingEP = computed(() => totalEP.value - usedEP.value);
            const epUsagePct = computed(() => usedEP.value / totalEP.value);
            
            const hullCost = computed(() => Math.floor(chassis.value.cost * templateCostMult.value));
            const modsCost = computed(() => installedMods.value.reduce((total, mod) => total + getModCost(mod), 0));
            const licensingCost = computed(() => installedMods.value.reduce((total, mod) => {
                if (mod.isStock) return total;
                const def = EQUIPMENT.find(e => e.id === mod.defId);
                if (!def || !def.availability) return total;
                const feePct = LICENSE_FEES[def.availability] || 0;
                return total + (getModCost(mod) * feePct);
            }, 0));
            const totalCost = computed(() => hullCost.value + modsCost.value + licensingCost.value);

            function addMod(defId, location, isNonStandard = false) {
                const def = EQUIPMENT.find(e => e.id === defId);
                if (!def) return;
                if (def.exclusiveGroup) {
                    const existing = installedMods.value.find(m => {
                        const mDef = EQUIPMENT.find(e => e.id === m.defId);
                        return mDef && mDef.exclusiveGroup === def.exclusiveGroup;
                    });
                    if (existing) removeMod(existing.instanceId);
                }
                installedMods.value.push({ instanceId: crypto.randomUUID(), defId, location, miniaturization: 0, isStock: false, isNonStandard });
            }
            function removeMod(instanceId) { installedMods.value = installedMods.value.filter(m => m.instanceId !== instanceId); }
            function reset() { activeTemplate.value = null; installedMods.value = []; engineering.hasStarshipDesigner = false; meta.name = ""; }
            function createNew(newChassisId) {
                reset(); chassisId.value = newChassisId;
                const ship = STOCK_SHIPS.find(s => s.id === newChassisId);
                if(ship && ship.defaultMods) ship.defaultMods.forEach(defId => {
                    const def = EQUIPMENT.find(e => e.id === defId);
                    let loc = 'Installed'; if(def && def.type === 'engine') loc = 'Aft Section';
                    if(def) installedMods.value.push({ instanceId: crypto.randomUUID(), defId: def.id, location: loc, miniaturization: 0, isStock: true, isNonStandard: false });
                });
            }
            function loadState(state) {
                if(!state) return; meta.name = state.meta.name; chassisId.value = state.configuration.baseChassis;
                if(Array.isArray(state.configuration.templates)) activeTemplate.value = state.configuration.templates[0] || null;
                else activeTemplate.value = state.configuration.template;
                engineering.hasStarshipDesigner = state.configuration.feats.starshipDesigner;
                installedMods.value = state.manifest.map(m => ({ instanceId: m.id, defId: m.defId, location: m.location, miniaturization: m.miniaturizationRank, isStock: m.isStock || false, isNonStandard: m.isNonStandard || false }));
            }
            watch([meta, chassisId, activeTemplate, installedMods, engineering], () => {
                const saveObj = {
                    apiVersion: "1.9",
                    meta: { name: meta.name, model: chassisId.value, version: "1.0", notes: "" },
                    configuration: { baseChassis: chassisId.value, template: activeTemplate.value, feats: { starshipDesigner: engineering.hasStarshipDesigner } },
                    manifest: installedMods.value.map(m => ({ id: m.instanceId, defId: m.defId, location: m.location, miniaturizationRank: m.miniaturization, isStock: m.isStock, isNonStandard: m.isNonStandard }))
                };
                localStorage.setItem('swse_architect_current_build', JSON.stringify(saveObj));
            }, { deep: true });

            return { meta, chassisId, activeTemplate, installedMods, engineering, showAddModDialog, chassis, template, currentStats, currentCargo, reflexDefense, totalEP, usedEP, remainingEP, epUsagePct, totalCost, hullCost, modsCost, licensingCost, shipAvailability, maxSrAllowed, isSrIllegal, sizeMultVal, addMod, removeMod, reset, createNew, loadState, getModCost, getModEp };
        });

        // --- BASE COMPONENTS ---
        const StatPanel = {
            template: `
            <q-card class="bg-grey-9 text-white">
                <q-card-section>
                    <div class="text-caption text-grey">{{ $t('ui.chassis') }}</div>
                    <div class="text-h5 text-primary">{{ getLocalizedName(store.chassis) }}</div>
                    <div class="q-mt-xs text-caption text-grey">{{ store.chassis.size }} Starship (x{{ store.sizeMultVal }})</div>
                </q-card-section>
                <q-separator dark />
                <q-card-section>
                    <div class="row q-col-gutter-xs text-center">
                        <div class="col-4"><div class="bg-grey-8 q-pa-xs rounded-borders"><div>{{ $t('stats.str') }}</div><div class="text-bold">{{ store.currentStats.str }}</div></div></div>
                        <div class="col-4"><div class="bg-grey-8 q-pa-xs rounded-borders"><div>{{ $t('stats.dex') }}</div><div class="text-bold">{{ store.currentStats.dex }}</div></div></div>
                        <div class="col-4"><div class="bg-grey-8 q-pa-xs rounded-borders"><div>{{ $t('stats.int') }}</div><div class="text-bold">{{ store.currentStats.int }}</div></div></div>
                    </div>
                    <div class="row q-mt-sm">
                        <div class="col-12 row justify-between items-center q-pa-xs bg-primary rounded-borders"><span>{{ $t('stats.ref') }}</span><span class="text-h6">{{ store.reflexDefense }}</span></div>
                    </div>
                     <div class="row q-mt-xs text-center"><div class="col-12"><div class="bg-grey-8 q-pa-xs">{{ $t('stats.armor') }} +{{ store.currentStats.armor }}</div></div></div>
                    <div class="row q-mt-xs q-col-gutter-xs">
                        <div class="col-6"><div class="bg-grey-8 q-pa-xs text-center"><div>{{ $t('stats.hp') }}</div><div class="text-bold text-positive">{{ store.currentStats.hp }}</div></div></div>
                        <div class="col-6"><div class="bg-grey-8 q-pa-xs text-center"><div>{{ $t('stats.shields') }}</div><div :class="store.isSrIllegal ? 'text-bold text-negative' : 'text-bold text-cyan'">{{ store.currentStats.sr }} <q-tooltip v-if="store.isSrIllegal" class="bg-negative">Max SR: {{ store.maxSrAllowed }}</q-tooltip></div></div></div>
                        <div class="col-6"><div class="bg-grey-8 q-pa-xs text-center"><div>{{ $t('stats.dr') }}</div><div class="text-bold">{{ store.currentStats.dr }}</div></div></div>
                        <div class="col-6"><div class="bg-grey-8 q-pa-xs text-center"><div>{{ $t('stats.speed') }}</div><div class="text-bold">{{ store.currentStats.speed }}</div></div></div>
                    </div>
                </q-card-section>
            </q-card>
            `,
            setup() { return {}; } 
        };

        const SystemList = {
            template: `
            <div class="q-pa-md full-height column">
                <div class="row justify-between items-center q-mb-md"><div class="text-h6">{{ $t('ui.installed_systems') }}</div><q-btn round color="positive" icon="add" size="sm" @click="store.showAddModDialog = true" /></div>
                <q-scroll-area class="col"><q-list separator dark>
                    <q-item v-for="mod in store.installedMods" :key="mod.instanceId">
                        <q-item-section avatar><q-icon :name="getIcon(mod.defId)" color="primary" /></q-item-section>
                        <q-item-section>
                            <q-item-label>
                                {{ getName(mod.defId) }}
                                <q-badge v-if="!isModification(mod.defId) && getAvailability(mod.defId) === 'Military'" color="negative" label="Mil" class="q-ml-xs" />
                                <q-badge v-if="!isModification(mod.defId) && getAvailability(mod.defId) === 'Restricted'" color="warning" text-color="black" label="Res" class="q-ml-xs" />
                                <q-badge v-if="!isModification(mod.defId) && getAvailability(mod.defId) === 'Licensed'" color="info" label="Lic" class="q-ml-xs" />
                                <q-badge v-if="mod.isStock" color="grey-7" label="Stock" class="q-ml-xs" />
                                <q-badge v-if="mod.isNonStandard" color="warning" text-color="black" :label="$t('ui.ns_tag')" class="q-ml-xs" />
                            </q-item-label>
                            <q-item-label caption class="text-grey-5">
                                <span v-if="getEpDynamic(mod.defId)" class="text-positive">+{{ Math.abs(getEpDynamic(mod.defId)) }} EP</span><span v-else>{{ mod.location }}</span>
                            </q-item-label>
                        </q-item-section>
                        <q-item-section side>
                            <div class="text-right q-mr-sm">
                                <div class="text-caption text-amber">
                                    <span v-if="isVariableCost(mod.defId)" class="text-italic">{{ $t('ui.variable') }}</span>
                                    <span v-else>{{ format(store.getModCost(mod)) }}</span>
                                </div>
                            </div>
                            <div class="row items-center"><q-badge v-if="mod.miniaturization > 0" color="orange" label="Mini" class="q-mr-xs" /><q-btn flat round icon="delete" color="negative" size="sm" @click="store.removeMod(mod.instanceId)" /></div>
                        </q-item-section>
                    </q-item>
                    <div v-if="store.installedMods.length === 0" class="text-center text-grey q-pa-lg">No systems installed.</div>
                </q-list></q-scroll-area>
            </div>
            `,
            setup() { return {}; }
        };

        const ConfigPanel = {
            template: `
            <q-card class="bg-grey-9 text-white full-height column">
                <q-card-section class="col-auto">
                    <div class="text-h6">{{ $t('ui.engineering') }}</div>
                    <div class="row items-center">
                        <q-toggle dark v-model="store.engineering.hasStarshipDesigner" :label="$t('ui.designer')" color="primary" />
                        <q-btn flat round dense icon="info" size="xs" color="grey-5" class="q-ml-xs">
                            <q-tooltip content-class="bg-grey-9" max-width="250px">{{ $t('ui.starship_designer_tip') }}</q-tooltip>
                        </q-btn>
                    </div>
                </q-card-section>
                
                <q-separator dark />
                
                <q-card-section class="col-auto">
                    <div class="text-h6">{{ $t('ui.ledger') }}</div>
                    <div class="row justify-between text-grey-4"><span>{{ $t('ui.hull_base') }}</span><span>{{ format(store.hullCost) }}</span></div>
                    <div class="row justify-between text-grey-4"><span>{{ $t('ui.systems') }}</span><span>{{ format(store.modsCost) }}</span></div>
                    <div class="row justify-between text-grey-4"><span>{{ $t('ui.lic_fees') }}</span><span>{{ format(store.licensingCost) }}</span></div>
                    <q-separator dark class="q-my-xs" />
                    <div class="row justify-between text-h6 text-primary"><span>{{ $t('ui.total') }}</span><span>{{ format(store.totalCost) }}</span></div>
                    <div class="q-mt-md"><div class="row justify-between text-h6"><span>{{ $t('ui.free_ep') }}</span><span :class="store.remainingEP < 0 ? 'text-negative' : 'text-amber'">{{ store.remainingEP }}</span></div></div>
                </q-card-section>

                <q-separator dark />

                <q-card-section class="col-auto">
                    <div class="text-h6 q-mb-sm">{{ $t('ui.template') }}</div>
                    <q-select filled dark v-model="store.activeTemplate" :options="templateOptions" :label="$t('ui.template')" emit-value map-options dense options-dense><template v-slot:prepend><q-icon name="layers" /></template></q-select>
                </q-card-section>
            </q-card>
            `,
            setup() { return {}; }
        };

        const ShipSheet = {
            template: `
            <div class="swse-block">
                <div class="swse-header"><span>{{ store.meta.name || 'Untitled Ship' }}</span><span>CL {{ calculateCL }}</span></div>
                <div class="swse-sub">{{ store.chassis.size }} Starfighter ({{ getLocalizedName(store.chassis) }})</div>
                <div class="stat-grid">
                    <div><span class="bold">Init</span> +{{ getMod(store.currentStats.dex) }}; <span class="bold">Senses</span> Perception +{{ getMod(store.currentStats.int) }}</div>
                    <div class="section-title">Defense</div>
                    <div><span class="bold">Ref</span> {{ store.reflexDefense }} (Flat-footed {{ store.reflexDefense - getMod(store.currentStats.dex) }}), <span class="bold">Fort</span> {{ 10 + getMod(store.currentStats.str) }}; <span class="bold">+{{ store.currentStats.armor }} Armor</span></div>
                    <div><span class="bold">HP</span> {{ store.currentStats.hp }}; <span class="bold">DR</span> {{ store.currentStats.dr }}; <span class="bold">SR</span> {{ store.currentStats.sr }}; <span class="bold">Threshold</span> {{ store.currentStats.str + 10 }}</div>
                    <div class="section-title">Offense</div>
                    <div><span class="bold">Speed</span> fly {{ store.currentStats.speed }} squares (starship scale)</div>
                    <div v-for="w in weapons" :key="w.instanceId" class="weapon-line"><span class="bold">Ranged</span> {{ getName(w.defId) }} +5 ({{ getDmg(w.defId) }})</div>
                    <div class="section-title">Statistics</div>
                    <div class="stat-grid">
                        <div><span class="bold">Str</span> {{ store.currentStats.str }}</div>
                        <div><span class="bold">Dex</span> {{ store.currentStats.dex }}</div>
                        <div><span class="bold">Int</span> {{ store.currentStats.int }}</div>
                    </div>
                    <div><span class="bold">Base Atk</span> +2; <span class="bold">Grapple</span> +{{ 2 + (getMod(store.currentStats.str)) + (store.sizeMultVal > 1 ? 10 : 0) }}</div>
                    <div class="section-title">Systems</div>
                    <div>{{ systemNames }}</div>
                    <div class="section-title">Logistics</div>
                    <div class="stat-grid">
                        <div><span class="bold">Crew</span> {{ store.chassis.logistics.crew }}</div>
                        <div><span class="bold">Passengers</span> {{ store.chassis.logistics.pass }}</div>
                        <div><span class="bold">Cargo</span> {{ store.currentCargo }}</div>
                        <div><span class="bold">Consumables</span> {{ store.chassis.logistics.cons }}</div>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid #000; padding-top: 5px; text-align: right;">
                        <span class="bold">Total Cost:</span> {{ formatCreds(store.totalCost) }} <span style="font-size: 0.8em;">(Inc. {{ formatCreds(store.licensingCost) }} fees)</span>
                    </div>
                </div>
            </div>
            `,
            setup() { return {}; }
        };

        // --- WRAPPERS ---
        const StatPanelWrapper = {
            ...StatPanel,
            setup() { 
                const store = useShipStore();
                return { store, getLocalizedName }; 
            }
        };

        const SystemListWrapper = {
            ...SystemList,
            setup() {
                const store = useShipStore();
                const getName = (id) => { const def = EQUIPMENT.find(e => e.id === id); return getLocalizedName(def); };
                const getAvailability = (id) => { const def = EQUIPMENT.find(e => e.id === id); return def ? def.availability : ''; }
                const getIcon = (id) => { const e = EQUIPMENT.find(e => e.id === id); if (e?.type === 'weapon') return 'gps_fixed'; if (e?.type === 'engine') return 'speed'; if (e?.type === 'upgrade') return 'upgrade'; if (e?.type === 'modification') return 'swap_horiz'; return 'memory'; }
                const getEpDynamic = (id) => { const def = EQUIPMENT.find(e => e.id === id); if (def && def.stats && def.stats.ep_dynamic_pct) return Math.floor(store.chassis.baseEp * def.stats.ep_dynamic_pct); return null; }
                const isVariableCost = (id) => { const def = EQUIPMENT.find(e => e.id === id); return def && def.variableCost; }
                const isModification = (id) => { const def = EQUIPMENT.find(e => e.id === id); return def && def.category === 'Modifications'; }
                const format = (n) => n === 0 ? '-' : new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: 0 }).format(n) + ' cr';
                return { store, getName, getIcon, getEpDynamic, getAvailability, isVariableCost, isModification, format };
            }
        };

        const ConfigPanelWrapper = {
            ...ConfigPanel,
            setup() {
                const store = useShipStore();
                const { t } = useI18n();
                const templateOptions = computed(() => [
                    { label: t('ui.template') + ': ' + t('ui.none'), value: null },
                    ...TEMPLATES.map(tmp => ({ label: getLocalizedName(tmp), value: tmp.id }))
                ]);
                const format = (n) => new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: 0 }).format(n) + ' cr';
                return { store, templateOptions, format };
            }
        };

        const ShipSheetWrapper = {
            ...ShipSheet,
            setup() {
                const store = useShipStore();
                const getName = (id) => { const def = EQUIPMENT.find(e => e.id === id); return getLocalizedName(def); };
                const getMod = (score) => Math.floor((score - 10) / 2);
                const weapons = computed(() => store.installedMods.filter(m => { const def = EQUIPMENT.find(e => e.id === m.defId); return def && def.type === 'weapon'; }));
                const systemNames = computed(() => {
                    const nonWeapons = store.installedMods.filter(m => { const def = EQUIPMENT.find(e => e.id === m.defId); return def && def.type !== 'weapon' && def.type !== 'engine'; });
                    if (nonWeapons.length === 0) return i18n.global.t('ui.installed_systems');
                    return nonWeapons.map(m => getName(m.defId)).join(', ');
                });
                
                // Enhanced Damage Logic for Variants
                const getDmg = (id) => { 
                    if (id.includes('laser_light')) {
                        if (id.includes('quad')) return '5d10x2';
                        if (id.includes('twin')) return '4d10x2';
                        return '3d10x2';
                    }
                    if (id.includes('laser_med')) {
                        if (id.includes('quad')) return '6d10x2';
                        if (id.includes('twin')) return '5d10x2';
                        return '4d10x2';
                    }
                    if (id.includes('laser_hvy')) {
                        if (id.includes('quad')) return '7d10x2';
                        if (id.includes('twin')) return '6d10x2';
                        return '5d10x2';
                    }
                    if(id.includes('turbo')) return '7d10x5'; 
                    if(id.includes('proton')) return '9d10x2'; 
                    if(id.includes('ion')) return '5d10x2';
                    if(id.includes('concussion')) return '8d10x2';
                    if(id.includes('tractor')) return '-';
                    return '-'; 
                }
                const calculateCL = computed(() => { let cl = 10; if(store.chassis.size === 'Colossal') cl += 5; cl += Math.floor(store.installedMods.length / 2); if(store.template) cl += 2; return cl; });
                const formatCreds = (n) => new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: 0 }).format(n) + ' cr';
                return { store, getName, getMod, weapons, systemNames, getDmg, calculateCL, formatCreds, getLocalizedName };
            }
        };

        // MAIN SETUP
        const setup = () => {
            const $q = useQuasar();
            const { t, locale } = useI18n();
            const shipStore = useShipStore();
            
            const centerTab = ref('systems');
            const mobileTab = ref('overview');
            const hangarTab = ref('stock');
            const showHangarDialog = ref(false);
            
            const newModCategory = ref(null);
            const newModGroup = ref(null);
            const newModSelection = ref(null);
            const newModNonStandard = ref(false);
            const fileInput = ref(null);
            const showSheetDialog = ref(false);

            const stockFighters = computed(() => STOCK_SHIPS.filter(s => ['Huge', 'Gargantuan'].includes(s.size)));
            const stockFreighters = computed(() => STOCK_SHIPS.filter(s => s.name.includes('Freighter') || s.name === 'Shuttle'));
            const stockCapitals = computed(() => STOCK_SHIPS.filter(s => s.size.includes('Colossal') && !s.name.includes('Freighter') && !s.name.includes('Shuttle')));

            const categoryOptions = computed(() => {
                const cats = [...new Set(EQUIPMENT.map(e => e.category))];
                return cats.map(c => ({ label: t('cat.' + (c === 'Weapon Systems' ? 'weapons' : c === 'Movement Systems' ? 'movement' : c === 'Defense Systems' ? 'defense' : c === 'Modifications' ? 'mods' : 'accessories')), value: c }));
            });

            const groupOptions = computed(() => {
                if (!newModCategory.value) return [];
                const groups = [...new Set(EQUIPMENT.filter(e => e.category === newModCategory.value).map(e => e.group))];
                return groups.map(g => ({ label: g, value: g }));
            });

            const itemOptions = computed(() => {
                if (!newModGroup.value) return [];
                return EQUIPMENT.filter(e => e.group === newModGroup.value).map(e => ({
                    ...e,
                    label: getLocalizedName(e)
                }));
            });

            const selectedItemDef = computed(() => {
                if (!newModSelection.value) return null;
                return EQUIPMENT.find(e => e.id === newModSelection.value);
            });

            const isSizeValid = (itemDef) => {
                if (!itemDef.maxSize) return true;
                const rankIndex = SIZE_RANK.indexOf(itemDef.maxSize);
                const shipIndex = SIZE_RANK.indexOf(shipStore.chassis.size);
                return shipIndex <= rankIndex;
            };

            const previewCost = computed(() => {
                if (!selectedItemDef.value) return 0;
                return shipStore.getModCost({ defId: selectedItemDef.value.id, miniaturization: 0, isStock: false, isNonStandard: newModNonStandard.value });
            });

            const previewEp = computed(() => {
                if (!selectedItemDef.value) return 0;
                return shipStore.getModEp({ defId: selectedItemDef.value.id, miniaturization: 0, isStock: false, isNonStandard: newModNonStandard.value });
            });

            const resetGroup = () => { newModGroup.value = null; newModSelection.value = null; };
            const toggleLang = () => { locale.value = locale.value === 'en' ? 'es' : 'en'; };

            onMounted(() => { 
                const saved = localStorage.getItem('swse_architect_current_build'); 
                if (saved) { 
                    try { shipStore.loadState(JSON.parse(saved)); } 
                    catch(e) { console.error("Save corruption", e); shipStore.createNew('light_fighter'); } 
                } else {
                    shipStore.createNew('light_fighter');
                }
            });

            const installMod = () => {
                if(newModSelection.value) {
                    const def = EQUIPMENT.find(e => e.id === newModSelection.value);
                    let loc = 'Installed';
                    if (def) {
                        if (def.type === 'weapon') loc = 'Hardpoint'; else if (def.type === 'system') loc = 'Internal Bay'; else if (def.type === 'cargo') loc = 'Cargo Hold'; else if (def.type === 'modification') loc = 'Hull Config'; else if (def.type === 'engine') loc = 'Aft Section';
                    }
                    shipStore.addMod(newModSelection.value, loc, newModNonStandard.value);
                    newModSelection.value = null;
                    newModNonStandard.value = false; 
                }
            };
            
            const selectStockShip = (id) => { shipStore.createNew(id); showHangarDialog.value = false; }
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = jsyaml.load(e.target.result);
                        shipStore.loadState(data);
                        showHangarDialog.value = false;
                        $q.notify({ type: 'positive', message: 'Ship loaded successfully' });
                    } catch (error) {
                        console.error(error);
                        $q.notify({ type: 'negative', message: 'Failed to parse file' });
                    }
                };
                reader.readAsText(file);
            };

            const exportYaml = () => {
                const obj = JSON.parse(localStorage.getItem('swse_architect_current_build'));
                const yamlStr = jsyaml.dump(obj);
                const blob = new Blob([yamlStr], {type: 'text/yaml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ship_${obj.meta.name || 'untitled'}.yaml`;
                a.click();
            };

            const printSheet = () => { window.print(); };
            const openSheetPreview = () => { showSheetDialog.value = true; };
            
            // Enhanced Print Trigger with focus and delay for better reliability
            const triggerPrint = () => { 
                // Focus the window first (crucial for some browsers/iframes)
                window.focus();
                
                // Small timeout to ensure UI updates (like hiding buttons) have rendered
                setTimeout(() => {
                    window.print();
                }, 200);
            };
            
            const formatCreds = (n) => new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: 0 }).format(n) + ' cr';

            return { 
                shipStore, centerTab, mobileTab, hangarTab, showHangarDialog, showSheetDialog,
                newModCategory, newModGroup, newModSelection, newModNonStandard,
                categoryOptions, groupOptions, itemOptions, selectedItemDef, previewCost, previewEp, resetGroup, isSizeValid,
                fileInput, stockFighters, stockFreighters, stockCapitals, getLocalizedName, toggleLang,
                installMod, selectStockShip, handleFileUpload, exportYaml, printSheet, openSheetPreview, triggerPrint, formatCreds 
            };
        };

        // APP INITIALIZATION
        const app = createApp({
            setup
        });

        app.use(createPinia());
        app.use(Quasar);
        app.use(i18n);

        app.component('stat-panel', StatPanelWrapper);
        app.component('system-list', SystemListWrapper);
        app.component('config-panel', ConfigPanelWrapper);
        app.component('ship-sheet', ShipSheetWrapper);
        
        app.mount('#q-app');
    </script>
</body>
</html>
