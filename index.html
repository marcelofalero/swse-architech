<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWSE Starship Architect</title>
    
    <!-- Quasar & Vue Dependencies -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.prod.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet" type="text/css">
</head>
<body class="bg-grey-10 text-white">
    <div id="app-loading" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#1d1d1d;z-index:9999;display:flex;justify-content:center;align-items:center;color:white;font-family:sans-serif;">
        <div style="text-align:center;">
            <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
               <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
            </svg>
            <div style="margin-top:20px;">Loading SWSE Architect...</div>
        </div>
        <style>
            .spinner { animation: rotator 1.4s linear infinite; }
            @keyframes rotator { 0% { transform: rotate(0deg); } 100% { transform: rotate(270deg); } }
            .path { stroke-dasharray: 187; stroke-dashoffset: 0; transform-origin: center; animation: dash 1.4s ease-in-out infinite, colors 5.6s ease-in-out infinite; }
            @keyframes colors { 0% { stroke: #4285F4; } 25% { stroke: #DE3E35; } 50% { stroke: #F7B500; } 75% { stroke: #34A853; } 100% { stroke: #4285F4; } }
            @keyframes dash { 0% { stroke-dashoffset: 187; } 50% { stroke-dashoffset: 46.75; transform: rotate(135deg); } 100% { stroke-dashoffset: 187; transform: rotate(450deg); } }
        </style>
    </div>
    <div id="q-app" style="display:none">
        <q-layout view="hHh lpR fFf" class="no-print">
            
            <q-header elevated class="bg-grey-9 text-white">
                <q-toolbar>
                    <q-btn flat round icon="menu" @click="leftDrawerOpen = !leftDrawerOpen" v-if="$q.screen.gt.sm"></q-btn>
                    <q-btn flat round icon="rocket" size="md" class="q-mr-sm"></q-btn>
                    <q-toolbar-title>
                        SWSE Architect
                        <span class="text-subtitle2 q-ml-sm text-grey-4" v-if="shipStore.meta.name">{{ shipStore.meta.name }}</span>
                    </q-toolbar-title>
                    
                    <q-btn flat icon="garage" :label="$t('ui.hangar')" @click="showHangarDialog = true" class="q-mr-sm"></q-btn>
                    <q-btn flat icon="description" :label="$t('ui.sheet')" @click="openSheetPreview"></q-btn>
                    <q-btn flat icon="save" :label="$t('ui.export')" @click="exportYaml"></q-btn>
                    <q-btn flat icon="upload" :label="$t('ui.import')" @click="$refs.importInput.click()"></q-btn>
                    <input type="file" ref="importInput" @change="handleFileUpload" accept=".yaml,.yml,.json" style="display: none" />
                    <q-separator vertical spaced dark></q-separator>
                    <q-btn flat icon="extension" label="Custom Lib" @click="shipStore.showCustomManager = true" class="q-ml-sm"></q-btn>
                    <q-btn flat :label="$i18n.locale === 'en' ? 'ES' : 'EN'" @click="toggleLang" color="amber"></q-btn>
                    <q-btn flat round icon="tune" @click="rightDrawerOpen = !rightDrawerOpen" v-if="$q.screen.gt.sm"></q-btn>
                </q-toolbar>
            </q-header>

            <q-drawer show-if-above v-model="leftDrawerOpen" side="left" bordered class="bg-grey-10">
                <div class="fit q-pa-sm">
                    <stat-panel></stat-panel>
                </div>
            </q-drawer>

            <q-drawer show-if-above v-model="rightDrawerOpen" side="right" bordered class="bg-grey-10">
                <div class="fit q-pa-sm">
                    <config-panel></config-panel>
                </div>
            </q-drawer>

            <q-page-container>
                <q-page :class="$q.screen.gt.sm ? 'q-pa-md fit column no-wrap' : 'q-pa-md'">
                    
                    <!-- DESKTOP LAYOUT -->
                    <div v-if="$q.screen.gt.sm" class="col column">
                         <q-card class="bg-grey-9 col column">
                            <q-tabs v-model="centerTab" dense class="text-grey" active-color="primary" indicator-color="primary" align="justify">
                                <q-tab name="systems" :label="$t('ui.manifest')"></q-tab>
                            </q-tabs>
                            <q-separator></q-separator>
                            <q-tab-panels v-model="centerTab" animated class="bg-grey-9 col column">
                                <q-tab-panel name="systems" class="q-pa-none col column"><system-list></system-list></q-tab-panel>
                            </q-tab-panels>
                        </q-card>
                    </div>

                    <!-- MOBILE LAYOUT -->
                    <div v-else>
                        <q-tabs v-model="mobileTab" class="bg-grey-9 text-grey-5" active-color="primary" sticky>
                            <q-tab name="overview" icon="analytics" :label="$t('ui.overview')"></q-tab>
                            <q-tab name="systems" icon="build" :label="$t('ui.systems')"></q-tab>
                            <q-tab name="config" icon="tune" :label="$t('ui.config')"></q-tab>
                        </q-tabs>
                        
                        <q-tab-panels v-model="mobileTab" animated class="bg-transparent q-mt-md">
                            <q-tab-panel name="overview" class="q-pa-none"><stat-panel></stat-panel></q-tab-panel>
                            <q-tab-panel name="systems" class="q-pa-none"><system-list></system-list></q-tab-panel>
                            <q-tab-panel name="config" class="q-pa-none"><config-panel></config-panel></q-tab-panel>
                        </q-tab-panels>

                        <!-- Mobile Sticky Footer -->
                        <q-footer class="bg-grey-10 border-top-primary">
                            <div class="row items-center q-pa-sm justify-between">
                                <div class="column">
                                    <div class="text-caption text-grey-4">{{ $t('ui.free_ep') }}</div>
                                    <div :class="shipStore.remainingEP < 0 ? 'text-h6 text-negative' : 'text-h6 text-amber'">
                                        {{ shipStore.remainingEP }}
                                    </div>
                                </div>
                                <div class="text-h6 text-primary">
                                    {{ formatCreds(shipStore.totalCost) }}
                                </div>
                            </div>
                        </q-footer>
                    </div>

                </q-page>
            </q-page-container>
        </q-layout>

        <!-- SHEET PREVIEW DIALOG -->
        <q-dialog v-model="showSheetDialog" maximized transition-show="slide-up" transition-hide="slide-down">
            <q-card class="bg-white text-black">
                <q-bar class="bg-grey-9 text-white print-hide">
                    <q-space></q-space>
                    <q-btn dense flat icon="print" :label="$t('ui.print_btn')" @click="triggerPrint" class="q-mr-md"></q-btn>
                    <q-btn dense flat icon="close" v-close-popup></q-btn>
                </q-bar>
                <q-card-section class="q-pa-lg sheet-container"><ship-sheet></ship-sheet></q-card-section>
            </q-card>
        </q-dialog>

        <!-- ADD MOD DIALOG -->
        <q-dialog v-model="shipStore.showAddComponentDialog">
            <q-card class="bg-grey-9 text-white" style="min-width: 500px">
                <q-card-section>
                    <div class="text-h6">{{ $t('ui.install_system') }}</div>
                    <div class="text-caption text-grey">{{ $t('ui.install_caption') }}</div>
                </q-card-section>

                <q-card-section class="q-pt-none q-gutter-md">
                    <!-- Form Elements -->
                    <q-select filled dark v-model="newComponentCategory" :options="categoryOptions" :label="$t('ui.category')" emit-value map-options @update:model-value="resetGroup">
                        <template v-slot:prepend><q-icon name="folder" /></template>
                    </q-select>
                    <q-select filled dark v-model="newComponentGroup" :options="groupOptions" :label="$t('ui.sys_type')" emit-value map-options :disable="!newComponentCategory" @update:model-value="newComponentSelection = null">
                        <template v-slot:prepend><q-icon name="category" /></template>
                    </q-select>
                    <q-select filled dark v-model="newComponentSelection" :options="itemOptions" :label="$t('ui.component')" option-label="label" option-value="id" emit-value map-options :disable="!newComponentGroup">
                        <template v-slot:option="scope">
                            <q-item v-bind="scope.itemProps">
                                <q-item-section>
                                    <q-item-label>
                                        {{ scope.opt.label }} <span class="text-caption text-grey-5 q-ml-xs">({{ scope.opt.baseEp }} EP)</span>
                                        <q-badge v-if="scope.opt.availability === 'Licensed'" color="info" label="Lic" />
                                        <q-badge v-if="scope.opt.availability === 'Restricted'" color="warning" text-color="black" label="Res" />
                                        <q-badge v-if="scope.opt.availability === 'Military'" color="negative" label="Mil" />
                                        <q-badge v-if="scope.opt.availability === 'Illegal'" color="deep-purple" label="Ill" />
                                        <q-badge v-if="scope.opt.availability === 'Common' || !scope.opt.availability" color="positive" label="Com" />
                                    </q-item-label>
                                </q-item-section>
                                <q-item-section side v-if="!isSizeValid(scope.opt)">
                                    <q-icon name="warning" color="negative">
                                        <q-tooltip>
                                            <span v-if="scope.opt.maxSize">{{ $t('ui.max_size') }}: {{ scope.opt.maxSize }}</span>
                                            <span v-if="scope.opt.minShipSize">{{ $t('ui.min_size') }}: {{ scope.opt.minShipSize }}</span>
                                        </q-tooltip>
                                    </q-icon>
                                </q-item-section>
                            </q-item>
                        </template>
                    </q-select>
                    <div v-if="newComponentSelection">
                        <q-checkbox dark v-model="newComponentNonStandard" :label="$t('ui.non_standard')" color="warning">
                            <q-tooltip>{{ $t('ui.non_standard_tip') }}</q-tooltip>
                        </q-checkbox>
                    </div>
                    <q-card v-if="selectedItemDef" class="bg-grey-8 q-pa-sm q-mt-md" flat bordered>
                        <div class="row items-center justify-between">
                            <div>
                                <div class="text-subtitle2">{{ getLocalizedName(selectedItemDef) }} <span v-if="newComponentNonStandard" class="text-warning text-caption">({{ $t('ui.ns_tag') }})</span></div>
                                <div class="text-caption text-grey-4">
                                    <span v-if="selectedItemDef.variableCost">{{ $t('ui.cost_variable') }}</span>
                                    <span v-else>{{ $t('ui.base_cost') }}: {{ selectedItemDef.baseCost }} cr</span> | {{ $t('ui.base_ep') }}: {{ selectedItemDef.baseEp }}
                                    <br v-if="selectedItemDef.category !== 'Modifications'">
                                    <span v-if="selectedItemDef.category !== 'Modifications'">
                                        {{ $t('ui.avail') }}:
                                        <q-badge v-if="selectedItemDef.availability === 'Licensed'" color="info" label="Lic" />
                                        <q-badge v-if="selectedItemDef.availability === 'Restricted'" color="warning" text-color="black" label="Res" />
                                        <q-badge v-if="selectedItemDef.availability === 'Military'" color="negative" label="Mil" />
                                        <q-badge v-if="selectedItemDef.availability === 'Illegal'" color="deep-purple" label="Ill" />
                                        <q-badge v-if="selectedItemDef.availability === 'Common' || !selectedItemDef.availability" color="positive" label="Com" />
                                    </span>
                                    <q-icon v-if="!isSizeValid(selectedItemDef)" name="warning" color="negative" class="q-ml-xs">
                                        <q-tooltip>
                                            <span v-if="selectedItemDef.maxSize">{{ $t('ui.max_size') }}: {{ selectedItemDef.maxSize }}</span>
                                            <span v-if="selectedItemDef.minShipSize">{{ $t('ui.min_size') }}: {{ selectedItemDef.minShipSize }}</span>
                                        </q-tooltip>
                                    </q-icon>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-h6 text-amber">
                                    <span v-if="selectedItemDef.variableCost" class="text-italic text-body1">{{ $t('ui.variable') }}</span>
                                    <span v-else>{{ formatCreds(previewCost) }}</span>
                                </div>
                                <div class="text-caption text-positive">{{ previewEp }} EP</div>
                            </div>
                        </div>
                        <div v-if="selectedItemDef.sizeMult && !selectedItemDef.variableCost" class="text-xs text-grey-5 q-mt-xs">* {{ $t('ui.size_mult_msg', { size: shipStore.chassis.size }) }}</div>
                    </q-card>
                </q-card-section>
                <q-card-actions align="right">
                    <q-space></q-space>
                    <q-btn flat :label="$t('ui.cancel')" color="grey" v-close-popup></q-btn>
                    <q-btn unelevated :label="$t('ui.install')" color="positive" @click="installComponent" v-close-popup :disable="!newComponentSelection"></q-btn>
                </q-card-actions>
            </q-card>
        </q-dialog>

        <!-- CUSTOM MANAGER DIALOG -->
        <q-dialog v-model="shipStore.showCustomManager">
            <q-card class="bg-grey-9 text-white" style="min-width: 600px; height: 70vh; display: flex; flex-direction: column;">
                <q-card-section class="row items-center q-pb-none">
                    <div class="text-h6">Custom Components Library</div>
                    <q-space></q-space>
                    <q-btn icon="close" flat round dense v-close-popup></q-btn>
                </q-card-section>

                <q-card-section class="q-py-sm">
                    <div class="row q-gutter-sm">
                        <q-btn color="primary" icon="add" label="Create New" @click="shipStore.openCustomDialog()"></q-btn>
                        <q-btn color="secondary" icon="upload" label="Import JSON" @click="$refs.libraryInput.click()"></q-btn>
                        <q-btn color="accent" icon="download" label="Export JSON" @click="exportCustomLibrary" :disable="shipStore.customComponents.length === 0"></q-btn>
                        <input type="file" ref="libraryInput" @change="handleLibraryImport" accept=".json" style="display: none" />
                    </div>
                </q-card-section>

                <q-card-section class="col q-pa-none">
                    <q-scroll-area class="fit">
                        <q-list separator dark class="q-pa-md">
                            <q-item v-for="comp in shipStore.customComponents" :key="comp.id">
                                <q-item-section>
                                    <q-item-label>{{ comp.name }}</q-item-label>
                                    <q-item-label caption class="text-grey-5">{{ comp.type }} | {{ comp.baseCost }} cr | {{ comp.baseEp }} EP</q-item-label>
                                </q-item-section>
                                <q-item-section side>
                                    <div class="row q-gutter-xs">
                                        <q-btn flat round icon="edit" color="info" size="sm" @click="shipStore.openCustomDialog(comp.id)"></q-btn>
                                        <q-btn flat round icon="delete" :color="shipStore.isCustomComponentInstalled(comp.id) ? 'grey-8' : 'negative'" size="sm" @click="deleteCustomComponent(comp.id)">
                                            <q-tooltip v-if="shipStore.isCustomComponentInstalled(comp.id)">Uninstall from ship first</q-tooltip>
                                        </q-btn>
                                    </div>
                                </q-item-section>
                            </q-item>
                            <div v-if="shipStore.customComponents.length === 0" class="text-center text-grey q-pa-lg">
                                No custom components found. Create or Import one.
                            </div>
                        </q-list>
                    </q-scroll-area>
                </q-card-section>
            </q-card>
        </q-dialog>

        <!-- CREATE CUSTOM COMPONENT DIALOG -->
        <q-dialog v-model="shipStore.customDialogState.visible">
            <q-card class="bg-grey-9 text-white" style="min-width: 500px">
                <q-card-section>
                    <div class="text-h6">{{ shipStore.customDialogState.componentId ? 'Edit Custom Component' : 'Create Custom Component' }}</div>
                </q-card-section>
                <q-card-section class="q-pt-none">
                    <div class="column q-gutter-md">
                        <div><q-input filled dark v-model="newCustomComponent.name" label="Name"></q-input></div>
                        <div><q-select filled dark v-model="newCustomComponent.category" :options="categoryOptions" label="Category" emit-value map-options></q-select></div>
                        <div>
                            <q-select filled dark v-model="newCustomComponent.group" use-input hide-selected fill-input input-debounce="0" new-value-mode="add-unique" :options="groupOptionsFiltered" @filter="filterGroupFn" label="Group" hint="Select existing or type new" >
                                <template v-slot:no-option><q-item><q-item-section class="text-grey">Type to add new group</q-item-section></q-item></template>
                            </q-select>
                        </div>
                        <div><q-select filled dark v-model="newCustomComponent.type" :options="['weapon', 'system', 'engine', 'modification', 'cargo']" label="Type"></q-select></div>
                        <div class="row q-col-gutter-sm">
                            <div class="col"><q-input filled dark v-model="newCustomComponent.baseCost" label="Base Cost" type="number"></q-input></div>
                            <div class="col"><q-input filled dark v-model="newCustomComponent.baseEp" label="Base EP" type="number"></q-input></div>
                        </div>
                        <div>
                            <q-checkbox dark v-model="newCustomComponent.sizeMult" label="Cost Multiplied by Size"></q-checkbox>
                        </div>

                        <div>
                            <div class="text-subtitle2 q-mb-sm">Properties & Modifiers</div>
                            <div class="row q-col-gutter-sm items-center q-mb-md">
                                <div class="col">
                                    <q-select filled dark v-model="propertyToAdd" :options="propertyDefinitions" label="Select Property" dense option-label="label"></q-select>
                                </div>
                                <div class="col-auto">
                                    <q-btn icon="add" label="Add" color="primary" @click="addPropertyToCustomComponent" :disable="!propertyToAdd"></q-btn>
                                </div>
                            </div>

                            <div class="q-gutter-y-sm">
                                <div v-for="prop in activeProperties" :key="prop.key" class="row q-col-gutter-sm items-center">
                                    <div class="col">
                                        <!-- String/Text Inputs -->
                                        <q-input v-if="prop.def.type === 'string'" filled dark v-model="prop.value" :label="prop.def.label" dense></q-input>
                                        <q-input v-else-if="prop.def.type === 'text'" filled dark v-model="prop.value" :label="prop.def.label" type="textarea" autogrow dense></q-input>
                                        <q-input v-else-if="prop.def.type === 'number'" filled dark v-model="prop.value" :label="prop.def.label" type="number" dense></q-input>

                                        <!-- Exclusive Group Select -->
                                        <q-select v-else-if="prop.def.type === 'exclusive_select'" filled dark v-model="prop.value" use-input hide-selected fill-input input-debounce="0" new-value-mode="add-unique" :options="exclusiveOptionsFiltered" @filter="filterExclusiveFn" :label="prop.def.label" dense>
                                            <template v-slot:no-option><q-item><q-item-section class="text-grey">Type to add new exclusive group</q-item-section></q-item></template>
                                        </q-select>

                                        <!-- Size Select -->
                                        <q-select v-else-if="prop.def.type === 'size_select'" filled dark v-model="prop.value" :options="shipStore.db.SIZE_RANK" :label="prop.def.label" dense></q-select>
                                    </div>
                                    <div class="col-auto">
                                        <q-btn flat round icon="delete" color="negative" size="sm" @click="removePropertyFromCustomComponent(prop.key)"></q-btn>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </q-card-section>
                <q-card-actions align="right">
                    <q-btn flat label="Cancel" color="grey" v-close-popup />
                    <q-btn unelevated class="q-ml-sm" :label="shipStore.customDialogState.componentId ? 'Save Changes' : 'Create'" color="positive" @click="createCustomComponent" :disable="!newCustomComponent.name" />
                </q-card-actions>
            </q-card>
        </q-dialog>

        <!-- HANGAR DIALOG -->
        <q-dialog v-model="showHangarDialog">
            <q-card class="bg-grey-9 text-white" style="min-width: 500px; max-width: 90vw;">
                <q-card-section><div class="text-h6">{{ $t('ui.hangar') }}</div></q-card-section>
                <q-tabs v-model="hangarTab" dense class="text-grey" active-color="primary" indicator-color="primary" align="justify">
                    <q-tab name="stock" icon="factory" :label="$t('ui.new_stock')"></q-tab>
                    <q-tab name="import" icon="upload_file" :label="$t('ui.import_file')"></q-tab>
                </q-tabs>
                <q-separator dark></q-separator>
                <q-tab-panels v-model="hangarTab" animated class="bg-grey-9">
                    <q-tab-panel name="stock" style="height: 400px" class="q-pa-none">
                        <q-scroll-area class="full-height">
                            <q-list separator dark>
                                <q-item-label header class="text-grey-5">{{ $t('cat.fighters') }}</q-item-label>
                                <q-item clickable v-ripple v-for="ship in stockFighters" :key="ship.id" @click="selectStockShip(ship.id)"><q-item-section><q-item-label>{{ getLocalizedName(ship) }}</q-item-label><q-item-label caption class="text-grey-6">{{ ship.size }}</q-item-label></q-item-section><q-item-section side><q-btn flat round icon="chevron_right" color="primary" /></q-item-section></q-item>
                                <q-item-label header class="text-grey-5">{{ $t('cat.freighters') }}</q-item-label>
                                <q-item clickable v-ripple v-for="ship in stockFreighters" :key="ship.id" @click="selectStockShip(ship.id)"><q-item-section><q-item-label>{{ getLocalizedName(ship) }}</q-item-label><q-item-label caption class="text-grey-6">{{ ship.size }}</q-item-label></q-item-section><q-item-section side><q-btn flat round icon="chevron_right" color="primary" /></q-item-section></q-item>
                                <q-item-label header class="text-grey-5">{{ $t('cat.capitals') }}</q-item-label>
                                <q-item clickable v-ripple v-for="ship in stockCapitals" :key="ship.id" @click="selectStockShip(ship.id)"><q-item-section><q-item-label>{{ getLocalizedName(ship) }}</q-item-label><q-item-label caption class="text-grey-6">{{ ship.size }}</q-item-label></q-item-section><q-item-section side><q-btn flat round icon="chevron_right" color="primary" /></q-item-section></q-item>
                            </q-list>
                        </q-scroll-area>
                    </q-tab-panel>
                    <q-tab-panel name="import" style="height: 400px" class="column flex-center">
                        <q-icon name="upload_file" size="100px" color="grey-7" class="q-mb-md">{{ $t('ui.upload_yaml') }}</q-icon>
                        <div class="text-h6 q-mb-md">{{ $t('ui.upload_yaml') }}</div>
                        <input type="file" ref="fileInput" @change="handleFileUpload" accept=".yaml,.yml,.json" style="display: none" />
                        <q-btn color="primary" :label="$t('ui.select_file')" @click="$refs.fileInput.click()"></q-btn>
                    </q-tab-panel>
                </q-tab-panels>
            </q-card>
        </q-dialog>

    </div>

    <!-- DEPENDENCIES -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-i18n@9.2.2/dist/vue-i18n.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.umd.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-demi"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinia@2.1.7/dist/pinia.iife.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <!-- APPLICATION LOGIC -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
